a r X i v : 0 803 . 4060v1 [ c ond - m a t . s t a t - m e c h ] 28 M a r 2008 Canonical sampling through velocity - rescaling Giovanni Bussi , ∗ Davide Donadio , and Michele Parrinello Computational Science , Department of Chemistry and Applied Biosciences , ETH Z¨urich , USI Campus , Via Giuseppe Buﬃ 13 , CH - 6900 Lugano , Switzerland We present a new molecular dynamics algorithm for sampling the canonical distribution . In this approach the velocities of all the particles are rescaled by a properly chosen random factor . The algorithm is formally justiﬁed and it is shown that , in spite of its stochastic nature , a quantity can still be deﬁned that remains constant during the evolution . In numerical applications this quantity can be used to measure the accuracy of the sampling . We illustrate the properties of this new method on Lennard - Jones and TIP4P water models in the solid and liquid phases . Its performance is excellent and largely independent on the thermostat parameter also with regard to the dynamic properties . I . INTRODUCTION Controlling the temperature and assessing the qual - ity of the trajectories generated are crucial issues in any molecular dynamics simulation . 1 , 2 Let us ﬁrst recall that in conventional molecular dynamics the microcanonical ensemble NVE is generated due to the conservation laws of Hamilton’s equations . In this ensemble the number of particles N , the volume V and the energy E are kept con - stant . In the early days of molecular dynamics the tem - perature was controlled by rescaling the velocities until the system was equilibrated at the target temperature . Energy conservation was also closely monitored in order to check that the correct NVE ensemble was being sam - pled and as a way of choosing the integration time - step . Furthermore , energy conservation provided a convenient tool for controlling that the code was free from obvious bugs . Only in 1980 , in a landmark paper , 3 Andersen sug - gested that ensembles other than the microcanonical one could be generated in a molecular dynamics run in or - der to better mimic the experimental conditions . Here we only discuss his proposal for generating the canoni - cal ensemble NVT , in which the temperature T rather than the energy E is ﬁxed . Andersen’s prescription was rather simple : during the simulation a particle is chosen randomly and its velocity extracted from the appropri - ate Maxwell distribution . While formally correct , Ander - sen’s thermostat did not become popular . A supposedly poor eﬃciency was to blame , as well as the fact that dis - continuities in the trajectories were introduced . However its major drawback was probably the fact that one had to deal with an algorithm without the comforting no - tion of a conserved quantity on which to rely . Another type of stochastic dynamics which leads to a canonical distribution is Langevin dynamics . 4 Such a dynamics is not often used because it does not have an associated conserved quantity , the integration time - step is diﬃcult to control and the trajectories lose their physical mean - ing unless the friction coeﬃcient is small . For similar reasons , an algorithm 5 which is close to the simpliﬁed version of ours discussed in Section II A , has been even less popular . Inspired by the extended Lagrangian ap - proach introduced in Andersen’s paper to control the external pressure , Nos´e introduced his by now famous thermostat . 6 Diﬀerently from Andersen’s thermostat , the latter allowed to control the temperature without using random numbers . Furthermore , associated with Nos´e’s dynamics there was a conserved quantity . Thus it is not surprising that Nos´e’s thermostat is widely used , espe - cially in the equivalent form suggested by Hoover . 7 How - ever , Nos´e thermostat can exhibit non ergodic behavior . In order to compensate for this shortcoming the intro - duction of chains of thermostats was suggested , 8 but this spoils the beauty and simplicity of the theory and needs extra tuning . Alternative thermostats were suggested such as that of Evans 9 in which the total kinetic energy is kept strictly constant . This leads to a well deﬁned ensemble , the so - called isokinetic ensemble , which however cannot be experimentally realized . Another very popular thermo - stat is that of Berendsen . 10 In this approach Hamilton’s equations are supplemented by a ﬁrst order equation for the kinetic energy , whose driving force is the diﬀerence between the instantaneous kinetic energy and its target value . Berendsen’s thermostat is stable , simple to imple - ment and physically appealing , however it has no con - served quantity and is not associated to a well deﬁned ensemble , except in limiting cases . In spite of this , it is rather widely used . In this paper we propose a new method for control - ling the temperature that removes many of the diﬃcul - ties mentioned above . Our method is an extension of the Berendsen thermostat to which a properly constructed random force is added , so as to enforce the correct dis - tribution for the kinetic energy . A relaxation time of the thermostat can be chosen such that the dynamic tra - jectories are not signiﬁcantly aﬀected . We show that it leads to the correct canonical distribution and that there exists a uniﬁed scheme in which Berendsen’s , Nos´e’s and our thermostat can be formulated . A remarkable result is that a quantity can be deﬁned which is constant and plays a role similar to that of the energy in the micro - canonical ensemble . Namely , it can be used to verify how much our numerical procedure generates conﬁgurations that belong to the desired NVT ensemble and to provide 2 a guideline for the choice of the integration time - step . It must be mentioned that all the algorithms presented here are extremely easy to implement . In Section II we shall ﬁrst present a simpler version of our algorithm which is an extension of the time hon - ored velocity - rescaling . Later we shall describe its more general formulation , followed by a theoretical analysis of the new approach , a comparison with other schemes and a discussion of the errors deriving from the integration with a ﬁnite time - step . The following Sections III and IV are devoted to numerical checks of the theory and to a ﬁnal discussion , respectively . II . THEORY A . A canonical velocity - rescaling thermostat In its simplest formulation , the velocity - rescaling method consists in multiplying the velocities of all the particles by the same factor α , calculated by enforcing the total kinetic energy K to be equal to the average ki - netic energy at the target temperature ¯ K = N f 2 β , where N f is the number of degrees of freedom and β is the in - verse temperature . Thus , the rescaling factor α for the velocities is obtained as α = r ¯ K K . ( 1 ) Since the same factor is used for all the particles , there is neither an eﬀect on constrained bond lengths nor on the center of mass motion . This operation is usually per - formed at a predetermined frequency during equilibra - tion , or when the kinetic energy exceeds the limits of an interval centered around the target value . The sampled ensemble is not explicitely known but , since in the ther - modynamic limit the average properties do not depend on the ensemble chosen , even this very simple algorithm can be used to produce useful results . However , for small systems or when the observables of interest are depen - dent on the ﬂuctuations rather than on the averages , this method cannot be used . Moreover , it is questionable to assume that this algorithm can be safely combined with other methods which require canonical sampling , such as replica - exchange molecular dynamics . 11 We propose to modify the way the rescaling factor is calculated , so as to enforce a canonical distribution for the kinetic energy . Instead of forcing the kinetic energy to be exactly equal to ¯ K , we select its target value K t with a stochastic procedure aimed at obtaining the desired ensemble . To this eﬀect we evaluate the velocity - rescaling factor as α = r K t K , ( 2 ) where K t is drawn from the canonical equilibrium distri - bution for the kinetic energy : ¯ P ( K t ) dK t ∝ K “ Nf 2 − 1 ” t e − βK t dK t . ( 3 ) This is equivalent to the method proposed by Heyes , 5 where one enforces the distribution in Eq . ( 3 ) by a Monte Carlo procedure . Between rescalings we evolve the sys - tem using Hamilton’s equations . The number of integra - tion time - steps can be ﬁxed or randomly varied . Both the Hamiltonian evolution and the velocity - rescaling leave a canonical probability distribution unaltered . Under the condition that the Hamiltonian evolution is ergodic in the microcanonical ensemble , it follows that our method samples the canonical ensemble . 12 More precisely , Hamil - ton’s equations sample a phase - space surface with ﬁxed center of mass and , for non - periodic systems , zero angu - lar momentum . Since the rescaling procedure does not change these quantities , our algorithm samples only the corresponding slice of the canonical ensemble . We shall neglect this latter eﬀect here and in the following as we have implicitly done in Eq . ( 3 ) . B . A more elaborate approach The procedure described above is very simple but dis - turbs considerably the velocities of the particles . In fact , each time the rescaling is applied the moduli of the veloci - ties will exhibit a fast ﬂuctuation with relative magnitude p 1 / N f . Thus , we propose a smoother approach in which the rescaling procedure is distributed among a number of time - steps . This new scheme is somehow related to what previously described in the same way as the Berendsen thermostat is related to standard velocity rescaling . First we note that it is not necessary to draw K t from the distribution in Eq . ( 3 ) at each time - step : the only requirement is that the random changes in the kinetic energy leave a canonical distribution unchanged . In par - ticular , the choice of K t can be based on the previous value of K so as to obtain a smoother evolution . We propose a general way of doing this by applying the fol - lowing prescriptions : 1 . Evolve the system for a single time - step with Hamilton’s equations , using a time - reversible area - preserving integrator such as velocity Verlet . 13 2 . Calculate the kinetic energy . 3 . Evolve the kinetic energy for a time corresponding to a single time - step using an auxiliary continuous stochastic dynamics . 4 . Rescale the velocities so as to enforce this new value of the kinetic energy . The choice of the stochastic dynamics has some degree of arbitrariness , the only constraint being that it has to leave the canonical distribution in Eq . ( 3 ) invariant . Here 3 we choose this dynamics by imposing that it is described by a ﬁrst - order diﬀerential equation in K . Since the aux - iliary dynamics on K is one - dimensional , its associated Fokker - Planck equation 14 must exhibit a zero - current so - lution . It can be shown that under these conditions the most general form is dK = (cid:18) D ( K ) ∂ log ¯ P ∂K + ∂D ( K ) ∂K (cid:19) dt + p 2 D ( K ) dW , ( 4 ) where D ( K ) is an arbitrary positive deﬁnite function of K , dW a Wiener noise , and we are using the Itoh convention . 14 Inserting the distribution of Eq . ( 3 ) in this equation one ﬁnds dK = (cid:18) N f D ( K ) 2 ¯ KK ( ¯ K − K ) − D ( K ) K + ∂D ( K ) ∂K (cid:19) dt + p 2 D ( K ) dW , ( 5 ) which can be used to generate the correct canonical dis - tribution . This result is independent on the choice of the function D ( K ) , but diﬀerent choices can lead to diﬀerent speeds of equilibration . Here we choose D ( K ) = 2 K ¯ K N f τ , ( 6 ) where the arbitrary parameter τ has the dimension of a time and determines the time - scale of the thermostat such as in Berendsen’s formulation . This leads to a very transparent expression for the auxiliary dynamics dK = ( ¯ K − K ) dt τ + 2 s K ¯ K N f dW √ τ . ( 7 ) Without the stochastic term this equation reduces to that of the standard thermostat of Berendsen . In the limit τ = 0 , the stochastic evolution is instantly thermal - ized and this algorithm reduces exactly to the stochastic velocity - rescaling approach described in Section II A . On the other hand , for τ → ∞ , the Hamiltonian dynamics is recovered . When a system is far from equilibrium , the de - terministic part in Eq . ( 7 ) dominates and our algorithm leads to fast equilibration like the Berendsen’s thermo - stat . Once the equilibrium is reached the proper canoni - cal ensemble is sampled , at variance with the Berendsen’s thermostat . There is no need to apply additional self - consistency procedures to enforce rigid bond constraints , as in the case of Andersen’s thermostat , since the choice of a single rescaling factor for all the atoms automatically preserves bond lengths . Furthermore , the total linear momentum and , for non - periodic systems , the angular momentum are conserved . The formalism can also be trivially ex - tended to thermalize independently diﬀerent parts of the system , e . g . , solute and solvent , even using diﬀerent pa - rameters τ for the diﬀerent subsystems . Interestingly , dissipative particle dynamics 15 can be included in our scheme if diﬀerent thermostats are applied to all the par - ticles pairs that are within a given distance . We have already noted that Berendsen’s thermostat can be recovered from ours by switching oﬀ the noise . Also Nos´e’s thermostat can be recast in a form that par - allels our formulation . To this eﬀect , it is convenient to rewrite the auxiliary variable ξ of the Nos´e - Hoover ther - mostat in adimensional form ξ = ζτ and the mass of the thermostat as N f β τ 2 . In our scheme , Nos´e - Hoover dy - namics is obtained through these auxiliary equations for ζ and K : dK = − 2 ζK dt τ , ( 8a ) dζ = (cid:18) K ¯ K − 1 (cid:19) dt τ . ( 8b ) The corresponding Liouville equation for the probability distribution P ( K , ζ ) is τ ∂P ( K , ζ ; t ) ∂t = 2 ζP + 2 ζK ∂P ( K , ζ ; t ) ∂K − (cid:18) K ¯ K − 1 (cid:19) ∂P ( K , ζ ; t ) ∂ζ ( 9 ) which is stationary for ¯ P ( K , ζ ) dKdζ ∝ K “ Nf 2 − 1 ” e − βK e − Nfζ 2 2 dKdζ ( 10 ) which is the desired distribution . By comparing this for - mulation of the Nos´e - Hoover thermostat with our scheme we see that the variable ζ plays the same role as the noise . In the Nos´e - Hoover scheme the chaotic nature of the cou - pled equations of motion leads to a stochastic ζ . When the system to be thermostated is poorly ergodic , ζ is no longer stochastic and a chain of thermostats is needed . 8 C . Controlling the integration time - step When integrating the equations of motion using a ﬁnite time - step , a technical but important issue is the choice of an optimal value for the time - step . The usual paradigm is to check if the constants of motion are properly con - served . For example , in the microcanonical ensemble , sampled using the Hamilton’s equations , the check is done on the total energy of the system which is given by the Hamiltonian H ( x ) , where x = ( p , q ) is a point in phase space . When the Nos´e - Hoover thermostat is used , the expression for the conserved quantity H Nos´e is more complex and can be recast in the form : H Nos´e = H ( x ) + N f β (cid:18) ζ 2 2 + Z t 0 dt ′ τ ζ ( t ′ ) (cid:19) . ( 11 ) In this section we propose a quantity that can play the same role for our thermostat , even though we are dealing with a stochastic process . 4 Let us consider a deterministic or stochastic dynamics aimed at sampling a given probability distribution ¯ P ( x ) . It is convenient to consider a discrete form of dynamics . This is not a major restriction and , after all , on the com - puter any dynamics is implemented as a discrete process . Starting from a point x 0 in the phase space we want to generate a sequence of points x 1 , x 2 , . . . distributed ac - cording to a probability as close as possible to ¯ P ( x ) . Let M ( x i + 1 ← x i ) dx i + 1 be the conditional probability of reaching the point x i + 1 given that the system is at x i . In order to calculate statistical averages which are cor - rect independently of M , each point visited has to be weighted by w i which measures the probability that x i is in the target ensemble . The ratio between the weights of successive points is w i + 1 w i = M ( x ∗ i ← x ∗ i + 1 ) ¯ P ( x ∗ i + 1 ) M ( x i + 1 ← x i ) ¯ P ( x i ) , ( 12 ) where the conjugated point x ∗ i is obtained from x i invert - ing the momenta , i . e . , if x = ( p , q ) , x ∗ = ( − p , q ) . If the dynamics exactly satisﬁes the detailed balance one must have w i + 1 w i = 1 , which implies that w must be constant . However , if ¯ P ( x ) is sampled in an approximated way , the degree to which w is constant can be used to assess the accuracy of the sampling . Rather than in terms of weights , it is convenient to express this principle in terms of an eﬀective energy ˜ H i = − 1 β ln w i . ( 13 ) The evolution of ˜ H is given by ˜ H i + 1 − ˜ H i = − 1 β ln (cid:18) M ( x ∗ i ← x ∗ i + 1 ) ¯ P ( x ∗ i + 1 ) M ( x i + 1 ← x i ) ¯ P ( x i ) (cid:19) = − 1 β ln (cid:18) M ( x ∗ i ← x ∗ i + 1 ) M ( x i + 1 ← x i ) (cid:19) + H ( x i + 1 ) − H ( x i ) , ( 14 ) where the last line follows in the case of a canonical dis - tribution ¯ P ( x ) ∝ e − βH ( x ) . Let us now make use of this result in the context of our dynamics . This is most conveniently achieved if we solve the equations of motion alternating two steps . One is a velocity Verlet step , or any other area - preserving and time - reversible integration algorithm . In a step with such property , M ( x ∗ i ← x ∗ i + 1 ) = M ( x i + 1 ← x i ) and the change in ˜ H is equal to the change in H . The other is a velocity - rescaling step in which the scaling factor is determined via Eq . ( 7 ) . If we use the exact solution of Eq . ( 7 ) derived in the Appendix , this step satisﬁes the detailed balance and therefore does not change ˜ H . An idealized but realistic example of time evolution of H and ˜ H is shown in Fig . 1 . If we use this analysis and go to the limit of an in - ﬁnitesimal time - step we ﬁnd ˜ H ( t ) = H ( t ) − Z t 0 ( ¯ K − K ( t ′ ) ) dt ′ τ − 2 Z t 0 s K ( t ′ ) ¯ K N f dW ( t ′ ) √ τ , ( 15 ) - 2 0 2 H / ∆ H 0 5 10 15 20 25 t / ∆ t - 2 0 2 ~ H / ∆ H FIG . 1 : Schematic time series for H ( upper ) and ˜ H ( lower ) , in units of the root - mean - square ﬂuctuation of H . Time is in unit of the integration time - step . The solid lines represent the increments due to the velocity Verlet step , which is almost energy preserving . The dashed lines represent the increments due to the velocity - rescaling . Since only the changes due to the velocity Verlet steps are accumulated into ˜ H , this quantity is almost constant . On the other hand , H has the proper distribution . where the last two terms come from the integration of Eq . ( 7 ) along the trajectory . Note that a similar inte - gration along the path is present in H Nos´e . However in our scheme a stochastic integration is also necessary . In the continuum limit the changes in energy induced by the rescaling compensate exactly the ﬂuctuations in H . For a ﬁnite time - step this compensation is only approx - imate and the conservation of ˜ H provides a measure on the accuracy of the integration . This accuracy has to be interpreted in the sense of the ability of generating con - ﬁgurations representative of the ensemble . The physical meaning of Eq . ( 15 ) is that the ﬂuxes of energy between the system and the thermostat are exactly balanced . A further use of ˜ H is possible whenever high accu - racy results are needed and even the small error deriving from the use of a ﬁnite time - step integration needs to be eliminated . In practice , one can correct this error reweighting 16 the points with w i ∝ e − β ˜ H i . Alternatively , segments of trajectories can be used in a hybrid Monte Carlo scheme 17 to generate new conﬁgurations which are accepted or rejected with probability min ( 1 , e − β ( ∆ ˜ H ) ) . From the discussion above one understands that in many ways ˜ H has a role similar to E in the microcanon - ical ensemble . It is however deeply diﬀerent : while in the microcanonical ensemble E deﬁnes the ensemble and has a physical meaning , in the canonical ensemble the value of ˜ H simply depends on the chosen initial condi - tion . Thus , the value of ˜ H can be only compared for points belonging to the same trajectory . 5 III . APPLICATIONS In this section we present a number of test appli - cations of our thermostating procedure . Moreover , we compare its properties with those of commonly adopted thermostats , such as the Nos´e - Hoover and the Berendsen thermostat . To test the eﬃciency of our thermostat we compute the energy ﬂuctuations and the dynamic prop - erties of two model systems , namely a Lennard - Jones sys - tem and water , in their crystalline and liquid phases . All the simulations have been performed using a modiﬁed version of the DL POLY code 18 , 19 . We adopt the parameterization of the Lennard - Jones potential for argon , and we simulate a cubic box contain - ing 256 atoms . Calculations have been performed on the crystalline solid fcc phase at a temperature of 20 K , and on the liquid phase at 120 K . The cell side is 21 . 6 ˚A for the solid and 22 . 5 ˚A for the liquid . Water is modeled through the commonly used TIP4P potential : 20 water molecules are treated as rigid bodies and interact via the disper - sion forces and the electrostatic potential generated by point charges . The long - range electrostatic interactions are treated by the particle mesh Ewald method . 21 The energy ﬂuctuations and the dynamic properties , such as the frequency spectrum and the diﬀusion coeﬃcient , have been computed on models of liquid water and hexagonal ice I h , in cells containing 360 water molecules with pe - riodic boundary conditions . The model of ice I h , with a ﬁxed density of 0 . 96 g / cm 3 , has been equilibrated at 120 K , while the liquid has a density of 0 . 99 g / cm 3 and is kept at 300 K . A . Controlling the integration time - step As discussed in Section II C , the eﬀective energy ˜ H can be used to verify the sampling accuracy and plays a role similar to the total energy in the microcanonical ensem - ble . In Fig . 2 we show the time - evolution of ˜ H for the Lennard - Jones system at 120 K with two diﬀerent inte - gration time - steps , namely ∆ t = 5 fs and ∆ t = 40 fs . In both cases , we use τ = 0 . 1 ps for the thermostat time - scale . With ∆ t = 5 fs the integration is accurate and the eﬀective energy ˜ H is properly conserved , in the sense that it does not exhibit a drift . Moreover , its ﬂuctuations are rather small , approximately 0 . 3 kJ / mol : for a compari - son , the root - mean - square ﬂuctuations in H are on the order of 16 kJ / mol . When the time - step is increased to ∆ t = 40 fs , the integration is not accurate and there is a systematic drift in the eﬀective energy . For a comparison we show also the time - evolution of E in a conventional NVE calculation . The ﬂuctuations and drifts for E in the NVE calculation are similar to the ﬂuctuations and drifts for ˜ H in the NVT calculation . We notice that , while in the NVE calculation the system explodes at some point , the NVT calculation is always stable thanks to the ther - mostat . However , in spite of the stability , the drift in ˜ H indicates that the sampling is inaccurate under these FIG . 2 : ( color online ) Total energy E ( left axis ) and eﬀective energy ˜ H ( right axis ) , respectively for a NVE simulation and for a NVT simulation using our thermostat , with τ = 0 . 1 ps , for Lennard - Jones at 120 K . In the upper panel , the calcula - tion is performed with a time - step ∆ t = 5 fs , and E ( or ˜ H ) does not drift . In the lower panel , the calculation is performed with a time - step ∆ t = 40 fs , and E ( or ˜ H ) drifts . conditions . B . Energy ﬂuctuations While the average properties are equivalent in all the ensembles , the ﬂuctuations are diﬀerent . Thus we use the square ﬂuctuations of the conﬁgurational and kinetic energies , which are related to the speciﬁc heat of the system , 1 to check whether our algorithm samples the canonical ensemble . Therefore we perform 1 ns long molecular dynamics runs using our thermostat with dif - ferent choices of the parameter τ , spanning three orders of magnitude . An integration time - step ∆ t = 5 fs is adopted , which yields a satisfactory conservation of the eﬀective energy , as veriﬁed in the previous section . For comparison , we also calculate the ﬂuctuations using the Nos´e - Hoover thermostat , which is supposed to sample the proper ensemble . The results for the Lennard - Jones system , both solid and liquid , are presented in Fig . 3 . The ﬂuctuations are plotted in units of the ideal - gas kinetic - energy ﬂuctuation . For the liquid [ panels ( c ) and ( d ) ] the Nos´e - Hoover and our thermostat give consistent results for a wide range of values of τ for both the ki - netic and conﬁgurational energy ﬂuctuations . The Nos´e - Hoover begins to fail only in the regime of small τ , due to the way the extra variable of the thermostat is integrated . For the solid [ panels ( a ) and ( b ) ] the ergodicity problems of Nos´e - Hoover’s thermostat appear for τ > 0 . 2 ps , in terms of poor sampling . We notice that increasing τ the ﬂuctuations tend to their value in the microcanonical en - semble . On the other hand , our procedure is correct over the whole τ range , both for the solid and for the liquid . 6 FIG . 3 : Square ﬂuctuations of the kinetic energy ∆ K 2 and of the potential energy ∆ U 2 , in units of N f k 2 B T 2 / 2 , for a Lennard - Jones solid at 20 K [ panels ( a ) and ( b ) ] and liquid at 120 K [ panels ( c ) and ( d ) ] , using the Berendsen ( • , dashed - dotted ) , the Nos´e - Hoover ( ◦ , dashed ) and our ( × , solid ) ther - mostat , plotted as function of the characteristic time of the thermostat τ . In these units the analytical value for the ﬂuc - tuations of the kinetic energy is 1 . In Fig . 3 we also plot the ﬂuctuations calculated using the Berendsen thermostat . It is clear that both for the liquid and for the solid the results are strongly dependent on the choice of the τ parameter . In the limit τ → 0 the Berendsen thermostat tends to the isokinetic ensemble , which is consistent with the canonical one for properties depending only on conﬁgurations : 9 thus , the ﬂuctuations in the conﬁgurational energy tend to the canonical limit , while the ﬂuctuations in the kinetic energy tend to zero . In Fig . 4 we present a similar analysis done on water [ panels ( c ) and ( d ) ] and ice [ panels ( a ) and ( b ) ] . For this system the equations of motion have been integrated with a time - step ∆ t = 1 fs . In this case we only performed the calculation with Nos´e - Hoover’s thermostat and with ours . Nos´e - Hoover’s thermostat is not eﬃcient for ice in the case of τ larger than 0 . 2 ps , and also for water in the case of τ larger than 2 ps . On the other hand , the per - formance of our thermostat is again fairly independent from the choice of τ . FIG . 4 : Square ﬂuctuations of the kinetic energy ∆ K 2 and of the potential energy ∆ U 2 , in units of N f k 2 B T 2 / 2 , for ice at 120 K [ panels ( a ) and ( b ) ] and water at 300 K [ panels ( c ) and ( d ) ] , using the Nos´e - Hoover ( ◦ , dashed ) and our ( × , solid ) thermostat , plotted as function of the characteristic time of the thermostat τ . In these units the analytical value for the ﬂuctuations of the kinetic energy is 1 . FIG . 5 : Vibrational density of states for the hydrogen atom in ice I h at 120 K . The spectra obtained with diﬀerent values of the relaxation time τ of our thermostat ( dashed and dotted lines ) are compared to a simulation in the NVE ensemble ( solid line ) . 7 τ ( ps ) D ( 10 − 5 cm 2 / s ) 0 . 002 3 . 63 ± 0 . 01 0 . 02 3 . 44 ± 0 . 06 0 . 2 3 . 51 ± 0 . 05 2 . 3 . 53 ± 0 . 01 NVE 3 . 47 ± 0 . 03 TABLE I : The diﬀusion coeﬃcient D of water at 300 K , as a function of the relaxation time τ of the thermostat . For a comparison , also the value obtained from a NVE trajectory is shown . C . Dynamic properties In order to check to what extent our thermostat aﬀects the dynamic properties of the systems , we have computed the vibrational spectrum of the hydrogen atoms in ice I h from the Fourier transform of the velocity - velocity auto - correlation function . The spectra have been computed , sampling 100 ps long trajectories in the NVT ensemble every 2 fs , at a temperature of 120 K , with two diﬀer - ent values of the relaxation time τ of the thermostat ( see Fig . 5 ) . They are compared to the spectrum of frequen - cies obtained in a run in the microcanonical ensemble . In all these runs the integration time - step ∆ t has been reduced to 0 . 5 fs . Two main regions can be distinguished in the vibrational spectrum of ice : a low frequency band corresponding to the translational modes ( on the left in Fig . 5 ) and a band at higher frequency related to the librational modes . Due to the use of a rigid model the high frequency intramolecular modes are irrelevant . All the features of the vibrational spectrum of ice I h are pre - served when our thermostat is used . When compared with the spectrum obtained from the NVE simulation , no shift of the frequency of the main peaks is observed for τ = 2 ps and the changes in their intensities are within numerical errors . It is worth noting that , although the thermostat acts directly on the particle velocities , it does not induce the appearance of ﬁctitious peaks in the spec - trum . The simulation done with τ = 0 . 002 ps shows that with a very short τ the shape of the ﬁrst translational broad peak is slighly aﬀected ( see the inset in Fig . 5 ) . The performances of our thermostat have been tested also with respect to the dynamic properties of liquids , computing the self - diﬀusion coeﬃcient D of TIP4P wa - ter . D is computed from the mean square displacement , through Einstein’s relation , on 100 ps long simulations equilibrated at a temperature of 300 K . The results for diﬀerent values of τ are reported in Tab . I and compared to the value of D extracted from an NVE simulation . The results obtained applying our thermostat are com - patible with the values of D reported in literature for the same model of water , 22 and are consistent with the one extracted from the microcanonical run . A marginal vari - ation with respect to the reference value occurs for very small τ = 0 . 002 ps . IV . CONCLUSION We devised a new thermostat aimed at performing molecular dynamics simulations in the canonical ensem - ble . This scheme is derived from a modiﬁcation of the standard velocity - rescaling with a properly chosen ran - dom factor , and generalized to a smoother formulation which resembles the Berendsen thermostat . Under the assumption of ergodicity , we proved analytically that our thermostat samples the canonical ensemble . Through a proper combination with a barostat , it can be used to sample the constant pressure – constant temperature en - semble . We check the ergodicity assumption on realis - tic systems and we compare the ergodicity of our pro - cedure with that of the Nos´e - Hoover thermostat , ﬁnding our method to be more ergodic . We also use the con - cept of sampling accuracy rather than trajectory accu - racy to assess the quality of the numerical integration of our scheme . To this aim , we introduce a new quantity , which we dub eﬀective energy , which measures the en - semble violation . This formalism allows a robust check on the ﬁnite time - step errors and can be easily extended to other kinds of stochastic molecular dynamics , such as the Langevin dynamics . V . ACKNOWLEDGEMENTS The authors would like to thank Davide Branduardi for useful discussions . Also Gabriele Petraglio is acknowl - edged for carefully reading the manuscript . APPENDIX A : EXACT PROPAGATOR FOR THE KINETIC ENERGY For the thermostat designed here it is essential that the exact solution of Eq . ( 7 ) is used . In the search for an analytical solution we are inspired by the fact that , if each individual momentum is evolved using a Langevin equation , then the evolution of K is described by the same Eq . ( 7 ) . Thus we ﬁrst deﬁne an auxiliary set of N f stochastic processes x i ( t ) with the following equation of motion dx i ( t ) = − x i ( t ) 2 dt τ + dW i ( t ) √ τ . ( A1 ) This is the equation for an overdamped harmonic oscilla - tor which is known also as the Ornstein - Uhlenbeck pro - cesses for which an analytical solution exists : 23 x i ( t ) = x i ( 0 ) e − t 2 τ + p 1 − e − tτ R i , ( A2 ) where the R i ’s are independent random numbers from a Gaussian distribution with unitary variance . Then we deﬁne the variable y y ( t ) = 1 N f N f X i = 1 x 2 i ( t ) . ( A3 ) 8 The equation of motion for y is obtained applying the Itoh rules 14 to Eq . ( A1 ) and recalling that the increments dW i are independent dy ( t ) = ( 1 − y ( t ) ) dt τ + 2 s y ( t ) N f dW ( t ) √ τ . ( A4 ) Since the equation of motion for x is invariant under ro - tation , we can assume without loss of generality that at t = 0 the multidimensional vector { x i } is oriented along its ﬁrst component { x i ( 0 ) } = (cid:26)q N f y ( 0 ) , 0 , . . . (cid:27) . ( A5 ) Combining Eqs . ( A3 ) and ( A2 ) we obtain for y ( t ) at ﬁnite time y ( t ) = e − t / τ y ( 0 ) + ( 1 − e − t / τ ) N f X i = 1 R 2 i N f + 2 e − t / 2 τ p 1 − e − t / τ s y ( 0 ) N f R 1 . ( A6 ) We now observe that with the substitution y ( t ) = K t ¯ K Eq . ( A4 ) is equivalent to Eq . ( 7 ) . Thus , with simple algebra , we ﬁnd the desired expression for the rescaling factor , α 2 = e − ∆ t / τ + ¯ K N f K ( 1 − e − ∆ t / τ ) ( R 21 + N f X i = 2 R 2 i ) + 2 e − ∆ t / 2 τ s ¯ K N f K ( 1 − e − ∆ t / τ ) R 1 ( A7 ) We observe here that there is no need to draw all the R i ’s Gaussian numbers , because P N f i = 2 R 2 i can be drawn directly from the Gamma distribution p Nf − 1 2 ( x ) = x „ Nf − 1 2 − 1 « e − x Γ “ Nf − 1 2 ” if N f − 1 is even or by adding a squared random Gaussian number to that extracted from p Nf − 2 2 ( x ) = x „ Nf − 2 2 − 1 « e − x Γ “ Nf − 2 2 ” if N f − 1 is odd . 24 A routine that evaluates Eq . ( A7 ) is available upon request . ∗ Electronic address : gbussi @ ethz . ch 1 M . P . Allen and D . J . Tildesley , Computer Simulation of Liquids ( Oxford Science Publications , 1987 ) . 2 D . Frenkel and B . Smit , Understanding Molecular Simula - tion ( Academic Press , 2002 ) , 2nd ed . 3 H . C . Andersen , J . Chem . Phys . 72 , 2384 ( 1980 ) . 4 T . Schneider and E . Stoll , Phys . Rev . B 17 , 1302 ( 1978 ) . 5 D . M . Heyes , Chem . Phys . 82 , 285 ( 1983 ) . 6 S . Nos´e , J . Chem . Phys . 81 , 511 ( 1984 ) . 7 W . G . Hoover , Phys . Rev . A 31 , 1695 ( 1985 ) . 8 G . J . Martyna , M . L . Klein , and M . Tuckerman , J . Chem . Phys . 97 , 2635 ( 1992 ) . 9 D . J . Evans and G . P . Morriss , Comput . Phys . Rep . 1 , 297 ( 1984 ) . 10 H . J . C . Berendsen , J . P . M . Postma , W . F . van Gun - steren , A . DiNola , and J . R . Haak , J . Chem . Phys . 81 , 3684 ( 1984 ) . 11 Y . Sugita and Y . Okamoto , Chem . Phys . Lett . 314 , 141 ( 1999 ) . 12 V . I . Manousiouthakis and M . W . Deem , J . Chem . Phys . 110 , 2753 ( 1999 ) . 13 W . C . Swope , H . C . Andersen , P . H . Berens , and K . R . Wilson , J . Chem . Phys . 76 , 637 ( 1982 ) . 14 C . W . Gardiner , Handbook of Stochastic Methods ( Springer , 2003 ) , 3rd ed . 15 T . Soddemann , B . D¨unweg , and K . Kremer , Phys . Rev . E 68 , 046702 ( 2003 ) . 16 W . H . Wong and F . Liang , Proc . Natl . Acad . Sci . U . S . A . 94 , 14220 ( 1997 ) . 17 S . Duane , A . D . Kennedy , B . J . Pendleton , and D . Roweth , Phys . Lett . B 195 , 216 ( 1987 ) . 18 W . Smith , M . Leslie , and T . R . Forester , CCLRC , Dares - bury Laboratory , Daresbury , England , Version 2 . 16 . 19 W . Smith and T . R . Forester , J . Mol . Graphics 14 , 136 ( 1996 ) . 20 W . L . Jorgensen , J . Chandrasekhar , J . F . Madura , R . W . Impey , and M . L . Klein , J . Chem . Phys . 79 , 926 ( 1983 ) . 21 T . Darden , D . York , and L . Pedersen , J . Chem . Phys . 98 , 10089 ( 1993 ) . 22 D . van der Spoel , P . J . van Maaren , and H . J . C . Berend - sen , J . Chem . Phys . 108 , 10220 ( 1998 ) . 23 H . Risken , The Fokker - Planck Equation ( Springer , 1989 ) , 2nd ed . 24 W . H . Press , S . A . Teukolsky , W . T . Vetterling , and B . P . Flannery , Numerical Recipes in FORTRAN : the Art of Scientiﬁc Computing ( Cambridge University Press , 1992 ) , 2nd ed .