Disentanglingconformational states of macromolecules in 3D - EM through likelihood optimization Sjors H W Scheres 1 , Haixiao Gao 2 , Mikel Valle 1 , 5 , Gabor T Herman 3 , Paul P B Eggermont 4 , Joachim Frank 2 & Jose - Maria Carazo 1 Although three - dimensional electron microscopy ( 3D - EM ) permits structural characterization of macromolecular assemblies in distinct functional states , the inability to classify projections from structurally heterogeneous samples has severely limited its application . We present a maximum likelihood – based classiﬁcation method that does not depend on prior knowledge about the structural variability , and demonstrate its effectiveness for two macromolecular assemblies with different types of conformational variability : the Escherichia coli ribosome and Simian virus 40 ( SV40 ) large T - antigen . Many tasks in the living cell are performed by macromolecular assemblies encompassing various binding interactions and accom - panied by conformational changes . The 3D - EM approach holds the promise of being able to visualize these ‘molecular machines’ in their various functional states . In the single - particle reconstruction approach ( see ref . 1 ) , individual molecules are visualized with an electron microscope , and the resulting projections—often number - ing tens of thousands—are combined in a three - dimensional density map . As the technique imposes no restrictions on the range of existing conformations in the sample , information about various functional states is often available in a single experiment . However , the combination of images in a three - dimensional reconstruction requires that they represent projections of identical three - dimensional objects and that their relative orientations be known . As the problems of conformational and orientational classiﬁcation are strongly intertwined , the coexistence of different conformations or ligand binding states in the sample has seriously limited the applicability of the 3D - EM approach 2 . Several strategies have been proposed for classiﬁcation of hetero - geneous projection data . The most potent one may be supervised classiﬁcation ( for example , as applied in refs . 3 , 4 ) , which requires prior structural knowledge about the sample heterogeneity to separate the data according to their similarity to two or more known reference structures . Here the dependency on a priori available information seriously limits the general applicability of this approach . The same can be said about approaches in which the conformational variability of a molecule is predicted by normal - mode analysis from an existing density map 5 . Most other methods use recursive schemes of two - dimensional classiﬁcation and three - dimensional reconstruction , in which orientational and class mem - bership assignment are alternated ( see ref . 1 and references therein ) . However , as these approaches typically rely on many strategic judgments , their effectiveness is difﬁcult to predict generally . Here we propose a classiﬁcation approach based on maximum - likelihood principles for handling structurally heterogeneous data . This methodology has potentially wide applicability for mining hidden information from biological data sets that are ( i ) very large ( in one of the experiments that we report , the number of raw data items was approximately 1 , 500 million ) , ( ii ) very noisy ( the signal - to - noise ratios of the data sets presented are in the order of 0 . 1 ) , and ( iii ) lack information on how the data items were generated ( in our case , for any projection , we have no prior information on the associated conformation and orientation ) . From a theoretical point of view , maximum - likelihood estimators are particularly well suited for the problem at hand because , as the amount of experi - mental data increases , these methods yield less biased results with smaller variances than alternative estimators 6 . Furthermore , pre - vious applications of the maximum - likelihood approach to related problems in the 3D - EM ﬁeld have demonstrated its particular robustness to high levels of noise 7 – 10 . The classiﬁcation technique described here aims to ﬁnd the most likely set of parameters ( Y ) to construct a statistical model describing structurally heterogeneous data , through optimization of the following log - likelihood function : L ð Y Þ ¼ X I i ¼ 1 ln X K k ¼ 1 Z j P ð X i j k ; j ; Y Þ P ð k ; j j Y Þ d j ; where for each experimental projection X i ( i ¼ 1 , y , I ) , we calculate all probabilities P ( X i | k , j , Y ) of observing X i given model Y , position j ( that is , rotation and translation ) and class k ( k ¼ 1 , y , K ) , also taking the prior probability of k and j , P ( k , j | Y ) , into account . These probability calculations are based on the assumption that all X i are projections of one RECEIVED 24 MAY ; ACCEPTED 6 NOVEMBER ; PUBLISHED ONLINE 10 DECEMBER 2006 ; DOI : 10 . 1038 / NMETH992 1 Centro Nacional de Biotecnologı´a , CSIC , Cantoblanco , 28049 , Madrid , Spain . 2 Howard Hughes Medical Institute , Health Research Inc . , Empire State Plaza , Albany , New York 12201 , USA . 3 The Graduate Center , City University of New York , New York , New York 10016 , USA . 4 Food and Resource Economics , University of Delaware , Newark , Delaware 19716 , USA . 5 Present address : CICBiogune , Parque Tecnolo´gico de Bizkaia , 48160 , Derio - Bizkaia , Spain . Correspondence should be addressed to J . - M . C . ( carazo @ cnb . uam . es ) . NATURE METHODS | VOL . 4 NO . 1 | JANUARY 2007 | 27 BRIEF COMMUNICATIONS © 2007 N a t u r e P ub li s h i ng G r oup h tt p : / / www . n a t u r e . c o m / n a t u r e m e t hod s of K underlying three - dimensional objects , to which white , Gaus - sian noise has been added . We use an expectation - maximization algorithm 11 to optimize the log - likelihood function , and show that it is equivalent to a three - dimensional projection - matching algorithm , where all experimental images are iteratively presented to a discretely sampled library of projections of K different reference structures ( for example , see ref . 12 ) . The main difference from conventional projection - matching protocols is that the discrete assignments of projection orientation and class membership are replaced by probability - weighted integrations over all possible assignments . We describe the algorithm and its implementation in the open - source package Xmipp 13 in detail in the Supplemen - tary Note online . We show that this approach permits the use of initial reference maps that are devoid of any prior information ( or bias ) about the structural variability in the sample . Such bias - free seeds are obtained by performing a single iteration of likelihood optimi - zation for K randomly drawn subsets of the data , using a low - resolution representation of the average structure as single reference . Therefore , classiﬁcation based on likelihood optimiza - tion is unsupervised because it depends only on a preliminary reconstruction of the data and a rough estimate for the number of existing classes , which determines the choice of the value of K . Taken together with the intrinsically combined treatment of orientational and conformational assignment , this suggests that , in contrast to existing approaches , classiﬁcation by likelihood optimization may be applicable to a broad range of structurally heterogeneous data sets . We tested the likelihood optimization methodology on two highly challenging cryo - EM data sets of macromolecular assemblies exhibiting different types of structural variability . We obtained the ﬁrst data set from a sample of 70 S E . coli ribosome particles in a translocational state before GTP hydrolysis ( H . Gao et al . , unpub - lished data ; see Supplementary Methods online ) and it represents a case of nonstoichiometric ligand binding . A preliminary recon - struction at 9 . 9 A˚ from 91 , 114 projection images exhibited blurred density for the 30 S subunit and fragmented density owing to the binding of elongation factor G ( EF - G ; B 4 % of the total mass of the complex ) , indicating problems of structural heterogeneity ( Sup - plementary Fig . 1 online ) . The second data set , comprising 5 , 738 projection images of SV40 large T - antigen dodecamers ( see Sup - plementary Methods ) , represents a case of ﬂexible domain move - ment , as this complex was previously observed to exhibit curvature of a varying degree along its central axis 14 . For the ribosome data , we chose K ¼ 4 and performed 25 iterations of likelihood optimization using all particles ( Supple - mentary Fig . 2 online ) . The four resulting structures could be interpreted in terms of two different conformations . Class 4 , comprising only 16 % of the particles , clearly represents the ribo - some in a ratcheted conformation ( that is , the 30 S subunit has rotated counter - clockwise relative to the 50 S subunit 15 ) with bound EF - G and a single tRNA positioned at the hybrid P / E site ( ML - 4 ; Fig . 1a ) . In contrast , the structures obtained from classes 1 – 3 represent the ribosome without ratcheting and without EF - G , but with three bound tRNAs at the A , P , and E sites ( ML - 1 , ML - 2 , ML - 3 ; Fig . 1a ) . ( The occupancy of the E site is attributed to free deacylated tRNA that has high afﬁnity for the ribosomal E site 15 . ) Slight overall rotations of the entire map are responsible for the main differences among classes 1 – 3 . These results are in excellent agreement with those obtained by supervised classiﬁcation into ﬁve subsets ( Fig . 1b , c ) . Based on the assumption that the heterogeneity in the data entailed a ratchet motion , the supervised approach ( Supplementary Fig . 3 online ) also yielded classes representing either ribosomes without ratcheting , lacking EF - G and with three tRNAs bound , or ratcheted ribosomes in complex with EF - G and a single tRNA . However , the unimodal character of the supervised classiﬁcation histogram , which served to divide the data set , and the observed partial density in the corresponding reconstructions , suggest that the intermediate classes of this approach are likely to represent mixtures of assemblies with different ratios of both conformations . The lack of clear distinctions among the different classes without the binding of EF - G , as well as the high similarity of corresponding structures obtained using both approaches , suggest the existence of only two genuinely different classes in this data set . The high degree of structural overlap between the EF - G – containing classes using both methods ( 75 % overlap in membership ) validates the maximum - likelihood approach to classiﬁcation . In contrast to the supervised approach , however , classiﬁcation by likelihood optimization does not depend on prior knowledge about the nature of the structural variability in the data and may thus be applicable in situations where such knowledge is unavailable . The large T - antigen data set represents a continuous form of structural variability , where a discrete number of classes cannot fully describe the continuum of conformations , but may serve to capture distinct representative states along the continuum . Consequently , the choice of K results from a trade - off between the degree of homogeneity desired within each class and the number of experi - mental images needed on statistical grounds to achieve sufﬁciently high resolution for its corresponding reconstruction . Because of the limited number of experimental particles in this data set , we chose K ¼ 3 and performed 20 iterations of likelihood optimization ( Supplementary Fig . 4 online ) . The resulting maps represent dodecamers with different degrees of bending along their central Cross - correlation difference N u m be r o f pa r t i c l e s 12 34 5 ML - 4 ML - 1 ML - 3 ML - 2 SU - ML - 1 22 , 176 particles 27 , 416 particles 25 , 651 particles 15 , 871 particles ML - 4 ML - 3 ML - 2 SU - 1 SU - 2 SU - 3 SU - 4 SU - 5 15 , 655 particles 18 , 193 particles 19 , 267 particles 14 , 949 particles 19 , 548 particles a c b Figure 1 | Comparison of supervised and maximum - likelihood classiﬁcations for the ribosome data set . ( a ) Reﬁned structures of the classes as determined by maximum - likelihood optimization ( ML ) . ( b ) Supervised - classiﬁcation histogram ( SU , black ) that served to divide the data set into ﬁve classes , and the corresponding histograms for the classes as determined by maximum - likelihood optimization ( blue and red ) . ( c ) Reﬁned structures of the classes as determined by supervised classiﬁcation . The two classiﬁcation approaches yielded similar structures , both in terms of overall quality ( with resolutions in the range of 12 – 14 A˚ ) and in terms of their interpretation : unratcheted ribosomes in complex with three tRNAs ( orange , green , magenta ) or ratcheted ribosomes in complex with one tRNA ( light - green ) and EF - G ( red ) . Classes SU - 5 and ML - 4 overlap to a high extent , having 11 , 415 particles in common . 28 | VOL . 4 NO . 1 | JANUARY 2007 | NATURE METHODS BRIEF COMMUNICATIONS © 2007 N a t u r e P ub li s h i ng G r oup h tt p : / / www . n a t u r e . c o m / n a t u r e m e t hod s axes , varying from 156 to 172 1 ( Fig . 2 ) . These results are in good agreement with random conical tilt experiments , where SV40 large T - antigen dodecamers with curvatures between 150 to 173 1 were observed 14 . The likelihood optimization allowed characterization of the structural variability without the need for additional tilting experiments , permitting a much simpler image acquisition scheme and opening the possibility to achieve higher resolution through the use of untilted micrographs . Moreover , the dodecamer with the highest curvature , as obtained by likelihood optimization reveals an opening of its central N - terminal domains , whichwas not observed for the random conical tilt reconstructions and may be implicated in the speciﬁc recognition of the SV40 origin of replication 14 . The results presented here indicate that likelihood optimization can be used to separate projection data without the need for prior knowledge about the distinct structures from which they originate , except for a rough estimate of the number of these structures . Several considerations may be relevant in the general case . First , the extensive computational cost of the likelihood optimization algorithm limits the angular sampling and the size of the images to be used . ( Using downscaled images of 64 (cid:1) 64 pixels and an angular sampling of 10 1 , classiﬁcation of the ribosome data still took 6 CPU months ; see Supplementary Note . ) Consequently , the attainable resolution of the distinct reconstructions will be limited , which will in turn limit the minimum size of the structural variability that can be detected . Nevertheless , high - resolution reconstructions may still be obtained through subsequent discrete classiﬁcation based on the maxima of the probability distributions for all particles . Typically , these distributions are relatively broad during the initial iterations of likelihood optimization , but tend to converge to near - delta functions ( see Supplementary Figs . 2 and 4 ) . Therefore , upon convergence , the maximum - likelihood estimate will be close to a discrete classiﬁcation , which allows the application of standard reﬁnement procedures with ﬁner sampling rates and larger images . Second , the number of different classes in the data is typically not known a priori , and the user may need to perform multiple calculations with different values of K . Additionally , as observed for the ribosome data , the algorithm may converge to slightly rotated but otherwise similar reconstructions , apparently as a result of accommodating particles with projection directions falling in between the angular grid used . This would imply that K should always be chosen higher than the expected number of distinct classes ( and would explain why a calculation with K ¼ 2 yielded only moderate separation of the structural variability in the ribosome data ; data not shown ) . In this light , it is interesting to note that for the ribosome data , an additional calculation with K ¼ 6 also resulted in a single class corresponding to EF - G – containing particles , which overlapped to 89 % with the equivalent class from the run presented . We made a similar observation for the SV40 large T - antigen data , where an additional calculation with K ¼ 4 resulted in classes with curvatures ranging from 159 to 172 1 . In this case , the classes with the highest curvature from both runs over - lapped to 87 % ( data not shown ) . Finally , as the experimental noise in cryo - EM images is typically non - white , we envisage further improvements of this technique could be made through the deﬁnition of a statistical model for colored noise , which is a topic for future research . The successful classiﬁcation of two cryo - EM data sets , represent - ing cases of nonstoichiometric ligand binding and ﬂexible domain movements , conﬁrms that the proposed method may be applicable to macromolecular complexes with a broad range of structural variability . Therefore , we expect that this technique will contribute considerably to meeting the challenges posed by 3D - EM visualiza - tion of macromolecular assemblies in distinct functional states . Note : Supplementary information is available on the Nature Methods website . ACKNOWLEDGMENTS We thank the Department of Computer Architecture and Electronics of the University of Almeria , and the Barcelona Supercomputing Center ( Centro Nacional de Supercomputacio´n ) for providing computing resources , and T . Elfving for his help with weighted least - squares minimization . This work was supported by grants from the European Union ( FP6 - 502828 and EGEE2 - 031688 to JMC ) , US National Institutes of Health ( HL70472 to G . T . H . and J . M . C . , and P41 RR01219 to J . F . ) , Howard Hughes Medical Institute ( to J . F . ) and the Spanish Comisio ´ n Interministerial de Ciencia y Tecnologı ´ a ( BFU2004 - 00217 to J . M . C . ) . COMPETING INTERESTS STATEMENT The authors declare that they have no competing ﬁnancial interests . Published online at http : / / www . nature . com / naturemethods / Reprints and permissions information is available online at http : / / npg . nature . com / reprintsandpermissions / 1 . Frank , J . Three - dimensional Electron Microscopy of Macromolecular Assemblies ( Oxford University Press , New York , 2006 ) . 2 . Orlova , E . V . & Saibil , H . R . Curr . Opin . Struct . Biol . 14 , 584 – 590 ( 2004 ) . 3 . Heymann , J . B . , Conway , J . F . & Steven , A . C . J . Struct . Biol . 147 , 291 – 301 ( 2004 ) . 4 . Gao , H . , Valle , M . , Ehrenberg , M . & Frank , J . J . Struct . Biol . 147 , 283 – 290 ( 2004 ) . 5 . Brink , J . et al . Structure 12 , 185 – 191 ( 2004 ) . 6 . Rice , J . A . Mathematical Statistics and Data Analysis ( Duxbury Press , Belmost , 1995 ) . 7 . Sigworth , F . J . J . Struct . Biol . 122 , 328 – 339 ( 1998 ) . 8 . Yin , Z . , Zheng , Y . , Doerschuk , P . C . , Natarajan , P . & Johnson , J . E . J . Struct . Biol . 144 , 24 – 50 ( 2003 ) . 9 . Scheres , S . H . W . et al . J . Mol . Biol . 348 , 139 – 149 ( 2005 ) . 10 . Scheres , S . H . W . , Valle , M . & Carazo , J . M . Bioinformatics 21 ( Suppl . 2 ) , ii243 – ii244 ( 2005 ) . 11 . Dempster , A . P . , Laird , N . M . & Rubin , D . B . J . Royal Statist . Soc . Ser . B 39 , 1 – 38 ( 1977 ) . 12 . Valle , M . et al . EMBO J . 21 , 3557 – 3567 ( 2002 ) . 13 . Sorzano , C . O . S . et al . J . Struct . Biol . 148 , 194 – 204 ( 2004 ) . 14 . Gomez - Lorenzo , M . G . et al . EMBO J . 22 , 6205 – 6213 ( 2003 ) . 15 . Valle , M . et al . Cell 114 , 123 – 134 ( 2003 ) . 172 ° 167 ° 156 ° 1 , 601 particles 2 , 332 particles 1 , 805 particles Figure 2 | Classiﬁcation of the SV40 large T - antigen data set according to continuously varying bend of the molecule’s long axis . The maps as obtained by maximum - likelihood optimization ( with resolutions in the range of 35 – 38 A˚ ) show various degrees of bending along the central axes of the dodecamers . The orientations of the sixfold symmetry axes through the hexameric C - terminal domains ( blue ) are indicated with arrows , and the angles between them are reported for each dodecamer . The N - terminal domains ( yellow ) of the most - bent dodecamer appear in an opened conformation ( indicated by red lines ) . NATURE METHODS | VOL . 4 NO . 1 | JANUARY 2007 | 29 BRIEF COMMUNICATIONS © 2007 N a t u r e P ub li s h i ng G r oup h tt p : / / www . n a t u r e . c o m / n a t u r e m e t hod s