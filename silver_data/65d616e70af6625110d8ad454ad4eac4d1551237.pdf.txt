Gctf : Real - time CTF determination and correction Kai Zhang Medical Research Council Laboratory of Molecular Biology , Division of Structural Studies , Francis Crick Avenue , Cambridge CB2 0QH , UK a r t i c l e i n f o Article history : Received 14 September 2015 Received in revised form 8 November 2015 Accepted 11 November 2015 Available online 19 November 2015 Keywords : Contrast transfer function Cryo - electron microscopy GPU program CTF determination a b s t r a c t Accurate estimation of the contrast transfer function ( CTF ) is critical for a near - atomic resolution cryo electron microscopy ( cryoEM ) reconstruction . Here , a GPU - accelerated computer program , Gctf , for accu - rate and robust , real - time CTF determination is presented . The main target of Gctf is to maximize the cross - correlation of a simulated CTF with the logarithmic amplitude spectra ( LAS ) of observed micro - graphs after background subtraction . Novel approaches in Gctf improve both speed and accuracy . In addi - tion to GPU acceleration ( e . g . 10 – 50 (cid:2) ) , a fast ‘1 - dimensional search plus 2 - dimensional reﬁnement ( 1S2R ) ’ procedure further speeds up Gctf . Based on the global CTF determination , the local defocus for each particle and for single frames of movies is accurately reﬁned , which improves CTF parameters of all particles for subsequent image processing . Novel diagnosis method using equiphase averaging ( EPA ) and self - consistency veriﬁcation procedures have also been implemented in the program for prac - tical use , especially for aims of near - atomic reconstruction . Gctf is an independent program and the out - puts can be easily imported into other cryoEM software such as Relion ( Scheres , 2012 ) and Frealign ( Grigorieff , 2007 ) . The results from several representative datasets are shown and discussed in this paper . (cid:2) 2015 The Author . Published by Elsevier Inc . ThisisanopenaccessarticleundertheCCBYlicense ( http : / / creativecommons . org / licenses / by / 4 . 0 / ) . 1 . Introduction Recent progress has allowed cryo - electron microscopy ( cryoEM ) to determine structures of bio - macromolecules to near - atomic resolution ( Nogales and Scheres , 2015 ) . This is due to developments in multiple ﬁelds , but especially better detectors and image processing methods ( Bai et al . , 2015 ) . The signiﬁcantly improved detective quantum efﬁciency ( DQE ) of direct detectors , such as Falcon II and K2 summit , makes the quality of the cryoEM reconstructions much better than when using traditional CCD or ﬁlm ( Bai et al . , 2015 ) . Recording movies on these detectors allows motion correction of entire micrographs or individual particles , which makes critical improvements for high resolution reconstruc - tion . More and more structures at near - atomic or atomic resolution are being solved recently by cryoEM ( Amunts et al . , 2015 ; Bartesaghi et al . , 2015 ; Jiang et al . , 2015 ; Paulsen et al . , 2015 ; Taylor et al . , 2015 ; Urnavicius et al . , 2015 ; Zhao et al . , 2015 ) . In contrast to a simple projection of a 3 - dimensional object , the cryoEM image of vitriﬁed specimen is modulated by contrast trans - fer function ( CTF ) . Because of the thin vitreous ice ﬁlm , the image formation can be well described by weak - phase approximation ( Wade , 1992 ) . Based on this approximation , the phase contrast is dominant while the amplitude contrast is very small . Therefore , the major factors that affect the CTF of cryoEM image formation are the defocus and aberration of lens . The effect of these factors makes CTF a frequency - dependent oscillatory function , modulating both the amplitudes and phases of the image . Original information of the images must be corrected using accurate CTF parameters in order to obtain a reliable 3D reconstruction . The oscillation of the CTF becomes more severe at higher frequency or under a higher defocus . For this reason , information restoration from cryoEM image is quite challenging , especially at high frequency , which makes accurate CTF determination an important factor for near - atomic 3D reconstructions . There are currently several programs available for CTF determi - nation ( Ludtke et al . , 1999 ; Mallick et al . , 2005 ; Mindell and Grigorieff , 2003 ; Penczek et al . , 2014 ; Shaikh et al . , 2008 ; Sorzano et al . , 2004 ; Tang et al . , 2007 ; Vargas et al . , 2013 ; Voortman et al . , 2011 ) . In a recent work , researchers systematically studied the performance of different programs ( Marabini et al . , 2015 ) . Each of the programs has its own advantages for certain purposes . The popular program CTFFIND3 ( Mindell and http : / / dx . doi . org / 10 . 1016 / j . jsb . 2015 . 11 . 003 1047 - 8477 / (cid:2) 2015 The Author . Published by Elsevier Inc . This is an open access article under the CC BY license ( http : / / creativecommons . org / licenses / by / 4 . 0 / ) . Abbreviations : 1D ( 2D , 3D ) , one ( two , three ) dimensional ; cryoEM , cryo - electron microscopy ; CCC , cross - correlation coefﬁcient ; CCD , Charge Coupled Device ; CCF , cross - correlation function ; CTF , contrast transfer function ; DQE , detective quantum efﬁciency ; EPA , equiphase averaging ; FFT , Fast Fourier Transform ; GPU , Graphic Processing Unit ; HAV , hepatitis A virus ; LAS , logarithmic amplitude spectra ; NFS , Network File System ; SNR , signal to noise ratio ; SSD , Solid State Disk . E - mail address : kzhang @ mrc - lmb . cam . ac . uk Journal of Structural Biology 193 ( 2016 ) 1 – 12 Contents lists available at ScienceDirect Journal of Structural Biology journal homepage : www . elsevier . com / locate / yjsbi Grigorieff , 2003 ) shows the most self - consistent results using real datasets in this benchmark test , in spite of a slightly lower rank using simulated micrographs . However , with the fast development of cryoEM , a lot of new challenges are being required for daily image processing . One challenging requirement is to further improve CTF accuracy for 3D reconstruction at near - atomic or real atomic resolution . Higher speed without sacriﬁcing the accuracy is also helpful to facilitate data processing with the development of automatic data collection at higher throughput . Besides , automatic self - consistency veriﬁcation of the CTF determination and quality evaluation of the micrographs will greatly facilitate the ultimate goal of automation in cryoEM . Here a robust GPU - accelerated computer program called Gctf for CTF determination , reﬁnement and correction is presented . GPU acceleration as well as an optimized programming strategy makes Gctf very fast . It can easily process thousands of micro - graphs within minutes using a single GPU card . The accuracy of the global CTF determination was veriﬁed by both manual scrutiny and automatic veriﬁcation . Astigmatism - based rotational averag - ing or what is called equiphase averaging ( EPA ) in Gctf makes the visibility of Thon rings signiﬁcantly improved for better diag - nosis . Gctf was tested using a variety of parameters , showing stable ranges of parameter selection and thus its potential power for CTF automation of many types of micrographs . Micrographs from many datasets collected at the MRC - LMB ( Cambridge ) and several other collaborating institutes proved its accuracy , speed , convenience and robustness in practical use . In almost all cases , there was no need for parameter optimization . Gctf also performed well with a number of deliberately selected challenging micrographs . Local reﬁnement and movie processing have also been imple - mented in Gctf . Local defocus reﬁnement for each single particle makes signiﬁcant improvements for 3D reconstructions carried out with datasets that have large defocus variation . Reﬁnement of defocus of each frame in a movie provides a way of tracking frame movement in the Z - direction during imaging . Beside the determination and reﬁnement of defocus in Gctf , CTF correction , automatic self - consistency veriﬁcation and micrographs quality evaluation are also available for better automation of cryoEM data processing . 2 . Theory and methods 2 . 1 . Application , usage and typical input / output of Gctf Gctf is basically designed to estimate the unknown CTF param - eters of EM micrographs . A summary of capability in the current version ( 1 . 0 ) of Gctf is listed as follows : ( a ) Determine overall CTF parameters of ( a . 1 ) each micrograph ( basic application ) ; ( a . 2 ) each particle stack from the same micrograph ; ( a . 3 ) each movie stack by ( a . 3 . 1 ) coherent averaging ; ( a . 3 . 2 ) incoherent averaging ; ( b ) Reﬁne user - provided CTF parameters of ( a . 1 ) , ( a . 2 ) , ( a . 3 ) ; ( c ) Reﬁne local CTF parameters based on ( a ) for ( c . 1 ) each frames from the same movie ; ( c . 2 ) each particle ( c . 2 . 1 ) using coordinate ﬁles as input ; ( c . 2 . 2 ) using particle stacks as input ; ( c . 2 . 3 ) from auto - detection by ( c . 2 . 3 . 1 ) user provided templates ( c . 2 . 3 . 2 ) Gaussian convolution ( d ) Auto - check CTF determination results after ( a ) , ( b ) or ( c ) by ( d . 1 ) self - consistency veriﬁcation ; ( d . 2 ) evaluation of the micrograph quality ; ( d . 3 ) overall defocus or astigmatism variation ; ( d . 4 ) local defocus variation ; ( e ) Generate better diagnostic ﬁle after ( a ) , ( b ) or ( c ) by EPA ( f ) Perform CTF correction after ( a ) , ( b ) or ( c ) . Additional details are summarized in Table 1 of ( Zhang , 2015 ) . All these kinds of processing only require a single and simple com - mand , running in batch mode for the entire dataset : Gctf ½ options (cid:3) < micrographs > Only MRC format are supported in the current version of Gctf . There are (cid:4) 40 parameters or options as inputs . The pixel size , spherical aberration , high tension , amplitude contrast are regarded as the most basic parameters and should be speciﬁed if they are not the same as default . All other parameters are only suggested for challenging cases or advanced usage ( e . g . local or movie reﬁnement ) . The basic output of Gctf contains four parts : ( 1 ) the standard output which gives real - time information about the processing of the micrographs ; ( 2 ) the log ﬁles which contain all the necessary input and output parameters for each micrograph ; ( 3 ) the diagno - sis ﬁle in MRC format ; ( 4 ) a STAR ﬁle which contains all the determined CTF parameters . Local or movie reﬁnement outputs additional ﬁles . The program is fully compatible with Relion ( Scheres , 2012 ) and the log ﬁles and output STAR ﬁles can be directly used for further 2D or 3D classiﬁcation . The STAR ﬁles can either contain CTF parameters for entire micrographs or individual particles . CTF parameters from the text log ﬁle can also be easily extracted and used for other programs such as Frealign ( Grigorieff , 2007 ) , EMAN ( Ludtke et al . , 1999 ; Tang et al . , 2007 ) , Spider ( Shaikh et al . , 2008 ) and Xmipp ( Sorzano et al . , 2004 ) etc . The diagnosis ﬁle is similar to that of that of CTFFIND3 ( Grigorieff , 2007 ; Mindell and Grigorieff , 2003 ) but contains additional user deﬁned options . Details will be discussed in the following sections : the basic knowledge of CTF ( Section 2 . 2 ) , a defocus inaccuracy criterion widely used in Gctf ( Section 2 . 3 ) , the main target of Gctf ( Section 2 . 4 ) and its implementation ( Section 2 . 5 ) , local ( Section 2 . 6 ) and movie ( Section 2 . 7 ) reﬁnement for better CTF accuracy , resolution - extension and Bfactor - switch methods for more challenging case ( Section 2 . 8 ) , equiphase averaging for better diagnosis ( Section 2 . 9 ) , self - consistency veriﬁcation and micro - graph evaluation ( Section 2 . 10 ) , the acceleration by GPU and improved algorithm and strategy ( Section 2 . 11 ) . 2 . 2 . Deﬁnition of contrast transfer function Image formation in a weak - phase approximation is modulated by the CTF which can be deﬁned as Eq . ( 1 ) . CTF ð ~ s Þ ¼ (cid:5) ﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃ 1 (cid:5) A 2 p (cid:6) sin ð c ð ~ s ÞÞ (cid:5) A (cid:6) cos ð c ð ~ s ÞÞ ¼ (cid:5) sin ð D / þ c ð ~ s ÞÞ ð 1 Þ where ~ s is the spatial frequency ; A is the amplitude contrast coefﬁ - cient ; c ð ~ s Þ is a function of ~ s representing the varying phases of the CTF , while D / is a global phase shift contributed by amplitude con - trast using empirical values . Ideally an image can be regarded as a projection of a 3D object convoluted by the CTF . In other words , the Fourier transform of an ideal image is the Fourier transform of a projection multiplied by the CTF . Note that an envelope function and noise severely affect the real image formation which must be taken into consideration for reliable CTF determination and correction . Defocus and spherical aberration of the microscope lens are the two major factors that affect the values of c ð ~ s Þ formulated as 2 K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 Eq . ( 2 ) . Theeffectbyotherfactorssuchascomaaberrationisignored in the current CTF determination method . c ð ~ s Þ ¼ c ð s ; h Þ ¼ (cid:5) p 2 C s k 3 s 4 þ p k z ð h Þ s 2 ð 2 Þ where s is the modulus of ~ s , s ¼ j ~ s j and ~ s ¼ s (cid:6) e i h ; k is the wavelength of an electron ; C s is the spherical aberration coefﬁcient ; z ð h Þ is the defocus in the direction with an varying azimuthal angle h , which can be precisely calculated using the following function Eq . ( 3 ) . z ð h Þ ¼ z u cos 2 ð h (cid:5) h ast Þ þ z v sin 2 ð h (cid:5) h ast Þ ð 3 Þ where the defocus z ð h Þ is determined based the three parameters ð z u ; z v ; h ast Þ , z u and z v represents the maximum or minimum defo - cus ; h ast is the ﬁxed angle between axis z u and x - axis of Cartesian coordinate system . All the parameters , including the rest parts of this paper , follow the convention as proposed previously ( Heymann et al . , 2005 ) . 2 . 3 . Defocus inaccuracy related phase error criterion The accuracy of defocus determination is very important for high - resolution cryoEM reconstructions . Assuming the difference between the true defocus of a micrograph and the estimated defocus is D z , the phase error D c ð s Þ is calculated by Eq . ( 4 ) : D c ð s Þ ¼ p k D zs 2 ð 4 Þ Derived from Eq . ( 4 ) , the defocus - inaccuracy dependent phase error is proportional to frequency squared for a certain micrograph Eq . ( 5 ) . D c ð s 1 Þ D c ð s 2 Þ ¼ s 21 s 22 ð 5 Þ Obviously from Eqs . ( 4 ) or ( 5 ) , an error in CTF determination , which can be ignored for a lower resolution reconstruction , might cause a critical error at high resolution . If the CTF is not properly determined , there are increasing phase errors against the fre - quency . The contrast of CTF is inverted for a 180 degree phase error . When this error is smaller than 90 degree , the probability to have the correct contrast of CTF is more than 50 % . Gctf uses such a 90 degree criterion in order to guarantee at least half of informa - tion from the EM images after CTF correction . Based on this criterion , CTF phase error versus frequency for different defocus errors between 10 nm and 200 nm were plotted ( Fig . 1a ) . The max - imum allowed CTF defocus errors were plotted against frequency for three typical voltages used in cryoEM reconstruction s ( Fig . 1b ) . In practice , defocus inaccuracy is only one of the factors that cause CTF phase error . Magniﬁcation distortion , chromatic or comatic aberration ( Glaeser et al . , 2011 ) , astigmatism inaccuracy , mechanical and beam induced movement of the samples , curva - ture or deformation of the carbon substrate ( Shatsky et al . , 2014 ) , sample thickness ( DeRosier , 2000 ) can all contribute to the phase error during an experiment . Data processing can also lead to large phase errors , especially at high frequency . Although Gctf uses this 90 degree criterion , it should be noted that the highest quality micrographs might need a stricter criterion in practice . 2 . 4 . CTF determination target The basic target is to estimate three unknown parameters ð z u ; z v ; h ast Þ as described in Eq . ( 6 ) : ^ z ð z u ; z v ; h ast Þ¼ arg z (cid:2) max CC Ln j F ð ~ s Þj(cid:5) Bg ð Ln j F ð ~ s ÞjÞ ; j CTF sim ð ~ s Þj(cid:6) e (cid:5) B 4 s 2 (cid:3) (cid:4) n o ð 6 Þ where ^ z ð z u ; z v ; h ast Þ is the estimated CTF parameters ; j F ð ~ s Þj is the amplitude spectrum ; Bg is the estimated background from Ln j F ð ~ s Þj , the logarithmic amplitude spectra ( LAS ) ; CTF sim ð ~ s Þ is the simulated CTF ; CC represents the cross - correlation ; B is an input B - factor used to down - weight high - frequency . 2 . 5 . Flow - chart of Gctf The overall ﬂow chart of Gctf can be described as shown in Fig . 2 . The preparation step contains the following process : han - dling input / output parameters ; setting up the program running environment ( e . g . checking and assigning the GPU device ) ; allocat - ing necessary memory for both CPU and GPU ; pre - calculating sharable parameters and data . The CTF determination contains the following steps ( Fig . 2 ) : read and write ﬁles ; box out sub - areas , perform a series of FFT to generate an averaged amplitude spectra ; convert the averaged 0 50 100 150 200 250 300 0 0 . 1 0 . 2 0 . 3 0 . 4 0 . 5 M ax i m u m a ll o w e d d e f o c u s e rr o r ( n m ) Spatial frequency ( Å - 1 ) Tolerance of defocus error ( 90° phase shift criterion ) 300kV 200kV 120kV 0 90 180 0 0 . 1 0 . 2 0 . 3 0 . 4 0 . 5 P h a se e rr o r ( d e g r ee ) Spatial frequency ( Å - 1 ) Phase shift due to defocus inaccuracy 10nm 30nm 50nm 100nm 200nm ( a ) ( b ) Fig . 1 . Relationship between CTF phase error and defocus inaccuracy . ( a ) The errors of CTF phases by different levels of defocus inaccuracy at 300 kV high tension . The dashed gray line represents the threshold for 90 (cid:3) phase shift criterion . ( b ) Based on the 90 (cid:3) criterion from ( a ) , the maximum defocus inaccuracy allowed at various resolutions for three typical high tension values ( 300 kV , 200 kV and 100 kV ) are plotted . K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 3 amplitude spectra to LAS ; estimate and subtract the background from LAS ; circularly average LAS to get a 1 - dimensional ( 1D ) pro - ﬁle ( Fig . 3a and b ) ; search for the average defocus that best ﬁts the observed 1D proﬁle ; perform a 2 - dimensional ( 2D ) reﬁnement of all three parameters ð z u ; z v ; h ast Þ . The key procedure of ‘1D search plus 2D reﬁnement’ is called ‘1S2R’ brieﬂy in the rest parts of this paper . In addition , local and movie reﬁnement , self - consistency veriﬁcation or phase ﬂipping can be performed if speciﬁed . Gctf then reads and processes another ﬁle . The estimation of the background uses a box - convolution of Ln j F ð ~ s Þj , similar to CTFFIND3 ( Mindell and Grigorieff , 2003 ) but different . In contrast to CTFFIND3 which uses the square root of power spectra ﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃ j P ð ~ s Þj p ( or j F ð ~ s Þj ) , Gctf uses Ln j F ð ~ s Þj to down - weight the strong signals at low frequency that tend to dom - inate and mislead the CTF determination . Background is estimated in 2D using logarithmic amplitude spectra ( LAS ) , Ln j F ð ~ s Þj . Circular average was performed using the background - subtracted LAS image . The averaged defocus z a ¼ ð z u þ z v Þ = 2 is estimated using the cir - cularly averaged 1D proﬁle ( blue curve in Fig . 3c ) . A large range of defocuses ( e . g . 5000 – 90 , 000 Å at a step size of 500 Å by default ) were used to generate a series of CTF curves in 1D . A cross - correlation function ( CCF ) is then calculated between these simulated CTF and the observed 1D proﬁle . The estimated defocus is the one ( red curve in Fig . 3d ) which yields the maximum cross - correlation coefﬁcient ( CCC ) ( the Pearson product - moment , the same for the rest part of this paper ) . The 1D result is extended for 2D using the parameter group ð z a þ D z = 2 ; z a (cid:5) D z = 2 ; h R Þ as initial seed for ð z u ; z v ; h ast Þ . D z is the input astigmatism as estimation and will be reﬁned in 2D . h R is ran - domly generated in the range of 0 – 30 (cid:3) . Five more seeds of h R are then generated using h R þ N (cid:7) 30 , where N belongs to { 1 , 2 , 3 , 4 , 5 } . Coarse 2D reﬁnement for each parameter group was performed in parallel . The maximized CCCs from the six seeds were compared and the best one was selected for accurate reﬁnement by Simplex method . Gctf only normalizes the CCC at last step for faster speed . 2 . 6 . Local reﬁnement strategy The accuracy of defocus for near - atomic resolution ( < 4 . 0 Å ) should be at least better than 40 nm at 300 kV as described ( Fig . 1 ) . However , stage tilt , uneven ice , a distorted supporting car - bon ﬁlm or charging can all lead to the defocus variation among particles within a cryoEM micrograph . Simply considering the tilt of micrograph will not generate accurate local defocus caused by nonlinear factors . Therefore , a new local reﬁnement strategy for each particle in one micrograph is implemented in Gctf to solve this problem without assuming any model for defocus variation . Gctf does a two - step estimation of single particle CTF determi - nation to deal with low signal to noise ratio ( SNR ) at high frequency . First , it determines the global CTF parameters for an entire micrograph . Using these global values as initial estimation , it does a local reﬁnement for each particle instead of ab initial CTF determination . The target is to estimate the amplitude spectra of each particle together with its surrounding areas . It uses Preparation Reading File Boxing and FFT Background estimation and reduction Local / movie Refinement ; Or self - consistency verification ; Or phase flipping cycle Local or movie ? self - consistency verification ? Phase flipping ? Yes No Rotational average , 1D search 2D refinement of Z ( U , V , θ ) Fast‘1S2R’ Fig . 2 . Flow chart of Gctf . RotationalAverage Ln | F | - Bg ( Ln | F | ) 1D profile 2D refine ( 2R ) 1D search ( 1S ) Fig . 3 . Flow chart of Gctf using a real micrograph . A micrograph with signiﬁcant astigmatism is presented to demonstrate the procedure clearly . 4 K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 Gaussian weighting according to the distances between the centers of the particles as described in Eq . ( 7 ) . j F i a v e ð ~ s Þj ¼ P nj ¼ 1 e (cid:5) d 2 ji 2 d 2 d (cid:6) s 2 2 d 2 s (cid:6) j F j ð ~ s Þj 0 @ 1 A P nj ¼ 1 e (cid:5) d 2 ji 2 d 2 d (cid:6) s 2 2 d 2 s 0 @ 1 A ð 7 Þ where j F i a v e j is the averaged amplitudes of i th particle ; j F j j the ampli - tudes of the j th neighbor ; d ji is the distance between particle i and its neighbor i ( including i itself ) and d d is the standard deviation of all distances to all neighbors ; d s is similar to d d but with a down - weighting of high - frequency . Note that the combination of the weighting by distance and frequency is a multiplication of the exponent . There are two different weighted averaging approaches in Gctf for local reﬁnement . One approach simply takes everything in the neighboring areas into account . The other approach uses the coordinates of picked particles or user deﬁned boxes . The coordi - nates are either provided by the user or auto - detected by cross - correlation with a Gaussian function or templates . 2 . 7 . CTF reﬁnement for movies One of the biggest advances in cryoEM recently is the invention of direct electron detectors which allow movie recording . Beam induced movement correction using movies has greatly improved the resolution of the ﬁnal reconstruction ( Bai et al . , 2013 ; Li et al . , 2013 ) . The movement in the X or Y direction of a micrograph is usually around several Ångstroms ( e . g . 1 – 10 Å ) , while the Z - direction movement can be over a hundred Ångstroms ( Russo and Passmore , 2014 ) . Although the movement is dominantly in the Z - direction , the small movement in the XY plane severely affects the quality of cryoEM micrographs . Motion correction programs normally consider only the drift in the XY plane because the eucentric height of the object does not affect its ideal 2D projection . However , EM micrographs are modulated by CTF , which is sensitive to Z - height changes . Beam induced movement might change the CTF from frame to frame . A hundred Ångstrom movement is not a signiﬁcant change even up to a 3 Å reconstruc - tion , but Fig . 1 suggests it might help to improve a reconstruction close to 2 Å . Accurate defocus reﬁnement for movie frames is implemented in Gctf to deal with large movement in the Z - direction . Similar to local defocus reﬁnement , movie defocus reﬁnement is performed in two steps . First , global CTF parameters are determined for the averaged micrograph of motion - corrected movies . Then based on the global values , parameters for each frame are reﬁned using an equally weighted average of adjacent frames ( suggested 5 – 10 ) to reduce the noise . Two options are provided in Gctf : coherent averaging Eq . ( 8 ) or incoherent averaging Eq . ( 9 ) . j F i ca ð ~ s Þj ¼ X i þ N = 2 j ¼ i (cid:5) N = 2 F j ð ~ s Þ N (cid:5)(cid:5)(cid:5)(cid:5)(cid:5) (cid:5)(cid:5)(cid:5)(cid:5)(cid:5) ð 8 Þ j F i ica ð ~ s Þj ¼ X i þ N = 2 j ¼ i (cid:5) N = 2 j F j ð ~ s Þj N ð 9 Þ where j F i ca ð ~ s Þj represents the coherent averaging of i th frame and i th the incoherent averaging ; N is the number of frames to be averaged . 2 . 8 . Resolution – extension and Bfactor - switch Strong structure factors at low spatial frequencies can lead to CTF determination bias . Direct CTF determination at high frequency using the ‘1S2R’ procedure might fail in the case of large astigmatism due to severe oscillation of CTF . Two options are pro - vided to deal with CTF determination at near - atomic resolution for micrographs that have very large astigmatism . They both make the ‘1S2R’ procedure more robust in such challenging case . One option is ‘resolution – extension ( RE ) ’ and the other is ‘Bfactor - switch ( BS ) ’ . In the ﬁrst method , Gctf determines initial CTF parameters using a relatively lower resolution ring ( e . g . 50 – 10 Å by default ) . These parameters are passed as input to the next step of CTF reﬁnement using a higher range ( e . g . 15 – 4 Å ) . In the second method , Gctf uses a larger Bfactor ( e . g . 500 Å 2 ) to signiﬁcantly down - weight high frequency for initial CTF determination . Then it switches to a smaller Bfactor ( e . g . 50 Å 2 ) to reﬁne the previously determined CTF parameters . Either method shows its power to deal with some challenging cases ( detailed results in Section 3 . 5 ) . The combination ( ‘REBS’ ) can even work slightly better in certain cases . 2 . 9 . Equiphase averaging ( EPA ) The astigmatism of practical datasets can range from several hundred to over a thousand Ångstroms . One of the tested datasets Equiphasecounter | Fi | ave ( a ) ( b ) Fig . 4 . Equiphase average . ( a ) The logarithmic amplitude spectra ( LAS ) after background reduction . The green point is the target pixel to be averaged . The red line represents all pixels with equiphases for the green point in this image . ( b ) A typical equiphase averaged LAS image . Resolution lower than 50 Å or higher than 7 Å has been excluded . K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 5 ( hepatitis A virus , HAV ) ( Wang et al . , 2015 ) had the astigmatism of (cid:4) 1800 Å but still reached 3 . 4 Å resolution . High astigmatism makes the Thon rings in the power spectra approximately ellipti - cal , which means circular averaging , Eq . ( 10 ) with constant s ð h Þ , will not provide a good estimation for them . Therefore the EPA approach is proposed after CTF determination for better diagnosis . The idea is to average the amplitudes of the micrograph FFT which have the same CTF phases c ð ~ s Þ ( Fig . 4 and Eqs . ( 11 ) and ( 12 ) ) . j F a v e ð ~ s 0 Þj ¼ j F a v e ð h 0 ; s 0 Þj ¼ 1 p Z p 2 (cid:5) p 2 j F ð h ; s ð h ÞÞj d h ð 10 Þ For a speciﬁc point with frequency magnitude s 0 and azimuthal angle h 0 in Fourier space , Eq . ( 10 ) represents how the rotational average of the amplitude j F a v e j is calculated . If the frequency s is independent of h , or in other words s is always equal to s 0 , it is the circular average . Using the method EPA , Gctf only averages the amplitudes with the same CTF phases as in Eq . ( 11 ) . For any angle h , the frequency magnitude s ð h Þ involved in the average is calculated using Eq . ( 12 ) . c ð s ; h Þ ¼ (cid:5) p 2 C s k 3 s 4 þ p k z ð h Þ s 2 ¼ c ð ~ s 0 Þ ð 11 Þ s ð h Þ ¼ ﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃ z ð h Þ (cid:5) ﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃ z 2 ð h Þ (cid:5) 2 C s k c ð ~ s 0 Þ = p p C s k 2 s ð 12 Þ The defocus z ð h Þ in Eqs . ( 11 ) and ( 12 ) is calculated using the def - inition in Eq . ( 3 ) . The correct solution for s ð h Þ derived from Eq . ( 11 ) is the one that lies within the normal range of frequency ( smaller than Nyquist ) . Note that the calculated s ð h Þ looks elliptical but not ideally elliptical because of the spherical aberration . This is important to generate better Thon rings at near atomic resolution than simply doing elliptical averaging . In the case of Cs - corrected micrograph where Cs is zero or near zero , it will cause problem using Eq . ( 12 ) in EPA method . Another solution is described in Eq . ( 13 ) . This is automatically chosen based on the user input Cs . s ð h Þ ¼ ﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃ c ð ~ s 0 Þ p k z ð h Þ s ð 13 Þ 2 . 10 . Self - consistency veriﬁcation and micrograph quality evaluation The CTF determination are affected by both the bias and ﬁtting error . Low resolution bias comes from over ﬁtting of strong false signals in a certain range of frequency , which normally derives from the background ( e . g . big ice contamination ) or signiﬁcant structural information ( e . g . ring - like structure or ring - like features in the structure ) . In contrast , random error mainly reﬂects the quality of the micrograph itself and only affects CTF determination at high frequency . Gctf deals with low resolution bias by indepen - dent resolution ring reﬁnement and uses these results to estimate the accuracy and reliability of CTF determination ( Fig . 1 in ( Zhang , 2015 ) ) . Starting with the global values plus deliberately added error ( 180 (cid:3) phase shift for highest resolution of that ring ) , Gctf recalculates the CTF parameters for each resolution ring ( e . g . 20 - 8 Å , 15 - 6 Å , 10 - 5 Å , 6 - 4 Å ) . In good cases , the CTF determination results from new reﬁnement will converge to original values from a wider resolution ring ( e . g . 50 - 4 Å by default ) , while in bad cases the reﬁnement becomes unstable and eventually generates big dif - ferences . Gctf converts the defocus difference to phase shift as deﬁned in Eq . ( 4 ) and Fig . 1 . A quality score is then deﬁned using this phase shift : 1 ( > p ) , 2 ( p - p / 2 ) , 3 ( p / 2 - p / 4 ) , 4 ( p / 4 - p / 8 ) , 5 ( < p / 8 ) . It is recommended to use micrographs with quality score equal or higher than 3 which is deﬁned as ‘USABLE’ in Gctf . Gctf also determines the quality of information at different resolution ring for each micrograph by calculating CCC between the simulated CTF and observed LAS after background subtraction . For each resolution ring , if the CCC is larger than zero in the condi - tion self - consistency veriﬁcation is convergent , it is regarded as usable . When the CCC values begin to oscillate above and below zero , the resolution ring is assumed not to contain usable informa - tion . In Gctf , convergence is prior to CCC evaluation . In other word , if the CTF determination does not converge for a certain micro - graph , there is no need for further quality evaluation of this micrograph by CCC . It is important to make sure the CTF determi - nation is convergent before doing anything on the micrograph quality evaluation . There are two reasons : ﬁrst , if the CTF determi - nation is essentially wrong , the micrograph quality could be evaluated to be very low even if it is good ; second , if the CTF determination is biased at high resolution ( e . g . one Thon ring off at 4 Å ) , the CCC is still very high , leading to a wrong judgment . The ﬁrst problem is easy to ﬁx by manual check . However , the second one is very challenging , because none of the current alternative CTF determination programs could guarantee a perfect ﬁtting at near - atomic resolution due to invisible Thon rings . Gctf provide this self - consistency veriﬁcation automatically and the powerful EPA for manual check . The values determined by Gctf can also be automatically checked for self - consistency in real time according to the historical reﬁnement results if this option is speciﬁed . One criterion is that the astigmatism ( absolute difference between z v and z u , e . g . 600 Å ) is ﬁxed for a certain dataset when the alignment of micro - scope keeps stable . Another useful check follows the observation that people tend to collect data at a certain range of defocus for a speciﬁc cryoEM sample . Once the difference of defocus value from the average is suddenly much larger ( e . g . 3 times ) than the stan - dard deviation or if the astigmatism suddenly varies more than expected , the micrograph or the CTF determination is potentially abnormal . 2 . 11 . Acceleration by GPU , ‘1S2R’ and optimized programming strategy Gctf was written in the GPU programming language CUDA ( C - language version ) ( https : / / developer . nvidia . com / cuda - zone ) . The speed of current high - end GPUs is around several TFLOPS ( e . g . NVIDIA GeForce GTX 980 at 4 . 6 TFLOPS ) , while high - end CPU is normally (cid:4) 100 GFLOPS ( e . g . Intel Xeon E5 - 2643 v2 at 168 GFLOPS ) . Therefore , programs can be potentially accelerated by (cid:4) 30 times faster using high - end GPUs in such case . In addition to GPU , the fast ‘1S2R’ procedure can accelerate Gctf by tens of times more . Since a 2D digital micrograph normally con - tains thousands of times data points than a 1D curve , an exhaustive search for the defocus and astigmatism in 2D would be incredibly slow . The acceleration by ‘1S2R’ becomes even more signiﬁcant than GPU when the step size of defocus used for initial search becomes smaller . This is because Gctf only uses the step size for 1D search , which typically takes (cid:4) 0 . 0003 s and is almost ignorable . The program was further optimized to run as fast as possible by improving the overall strategy ( Fig . 2 in ( Zhang , 2015 ) ) . First , instead of sequentially processing each ﬁle ( Fig . 2a in ( Zhang , 2015 ) ) , Gctf tries to process an entire dataset containing hundreds or thousands of micrographs together ( Fig . 2b in ( Zhang , 2015 ) ) . This speeds up the program because a lot of computing resources can be shared among the processing of all the ﬁles , the hardware only requires initializing once and sharable parameters , values etc . are also only calculated once ( Fig . 2b in ( Zhang , 2015 ) ) . This concept was not only used in the overall processing of hundreds or thousands of micrographs , but also in lots of the sub - procedures in the entire program . Optimization of ﬁle reading 6 K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 strategy can also make the speed of Gctf even faster ( Fig . 2c in ( Zhang , 2015 ) ) . Apart from the internal acceleration , a convenient script is also provided to help users take advantage of multiple GPU resources ( e . g . 10 ) in their local area network . The scripts can split the whole dataset into several smaller subsets ( e . g . 10 ) and use each GPU to process one subset . It can almost linearly speed up the program on multiple nodes / workstations / PCs using fast parallel ﬁle systems . 3 . Results and discussion 3 . 1 . Datasets used for testing Gctf Table 1 lists a summary of some tested datasets presented in this paper . 3 . 2 . Speed test and comparison The speed of Gctf was tested using different parameters on different devices . In general the speed can be comparable to that of simply reading ﬁles . The kernel of CTF ﬁtting only takes (cid:4) 0 . 1 s , using a currently available high - end GPU ( e . g . Nvidia GTX 980 ) . In addition to GPU acceleration , which has been shown to acceler - ate many programs by tens of times ( Li et al . , 2010 ; Xu et al . , 2010 ; Zhao and Chu , 2014 ) , Gctf also has signiﬁcantly improved algorithms and programming strategy ( Fig . 3 in ( Zhang , 2015 ) ) . Gctf is capable of handling different types of CTF determination and reﬁnement . The limiting factor is mainly the ﬁle reading or network speed ( Table 2 ) . In a test using dynactin micrographs ( Dataset - 5 , Table 1 ) , the average speed of Gctf can be even acceler - ated 3 times ( from 0 . 75 s to 0 . 26 s ) simply by using a fast SSD disk . This indicates that the speed limitation is at the ﬁle reading step . Changing the pixel size from 1 . 34 Å ( Dataset - 5 ) to 1 . 70 Å ( Dataset - 4 ) or 1 . 07 Å ( Dataset - 6 ) on cryoEM data does not affect the speed at all in this test ( with time differences < 0 . 001 s ) . Similar results were also observed on negative stain datasets ( Dataset - 2 , 3 ) . For movie CTF reﬁnement reading takes 5 – 30 s but once the movie is read into GPU RAM , processing takes less than 1 s . The limitation for local reﬁnement , however , is mainly the particle number which is approximately linear to the ﬁtting time . It’s much slower than global CTF determination , but very useful to improve the CTF parameters of each particle . Speed comparison was done with CTFFIND3 ( Mindell and Grigorieff , 2003 ) , CTFFIND4 ( Rohou and Grigorieff , 2015 ) , FASTDEF ( Vargas et al . , 2013 ) and ACE2 ( Mallick et al . , 2005 ) ( Fig . 5 ) . The last three were all claimed to be fast programs , among which ACE2 is the fastest in the current practical test . Gctf using a single GPU card is comparable to one hundred CPU cores by the other three fast programs . Nowadays , people may have alternative choice for doing fast CTF determination using a computer cluster or on a single GPU . However , it might be a better choice to use GPU due to its signiﬁcantly lower cost . 3 . 3 . Accuracy of modiﬁed ‘1S2R’ procedure Micrographs collected under a variety of conditions , including different doses , detectors , magniﬁcations , types of grid , and levels of astigmatism were tested . The plots of 1D cross - correlation func - tion ( CCF ) each showed a single clear peak ( Fig . 3 in ( Zhang , 2015 ) ) . One of the major concerns for estimating the averaged defocus using circular averaging is that it might fail due to large astigmatism . However , even in the case of a large astigmatism of (cid:4) 10 , 000 Å ( z u = 25 , 972 . 84 Å , z v = 15 , 062 . 04 Å , h = 37 . 22 (cid:3) ) , Gctf was still able to identify the correct defocus ( Dataset - 1 , Fig . 4 in ( Zhang , 2015 ) ) . Considering the astigmatism of micrographs under normal cryoEM imaging conditions is less than 1000 Å , and at most 2000 Å , an initial 1D search should work for almost all normal cryoEM micrographs . The results of global CTF determination were compared with the most popular program CTFFIND3 . So far , this program was used to determine the CTF in most near - atomic resolution cryoEM structures ( http : / / www . emdatabank . org / ) . For a randomly selected subset ( 123 micrographs ) of Dataset - 6 ( Table 1 ) , the difference between Gctf and CTFFIND3 is (cid:4) 40 Å in average ( Fig . 5 in ( Zhang , 2015 ) ) . Both programs could generate 100 % essentially correct CTF results using the default parameters ( manually checked ) . FASTED shows a globally smaller defocus ( (cid:4) 400 Å ) compared to Gctf or CTFFIND3 with 61 . 5 % essentially correct values using its own default parameters ( Fig . 5 in ( Zhang , 2015 ) ) . ACE2 only failed Table 1 Basic parameters of datasets used to test Gctf in this paper . Dataset ID Sample Type Microscope Detectors 1 Empty carbon Raw grid Spirit Orius CCD 2 Dynein Negative stain Spirit Orius CCD 3 Dynactin Negative stain Spirit Orius CCD 4 Dynactin On thin carbon Krios FalconII 5 Dynactin On thin carbon Krios FalconII 6 Dynactin On thin carbon Krios FalconII 7 Dynactin On thin carbon Polara FalconIII 8 HAV In pure ice Polara K2 summit 9 Chaperoin In pure ice Krios UltraScan CCD ID apix kV Cs Ac Dose Frames Image size 1 3 . 3 120 2 . 0 0 . 3 20 1 2048 (cid:2) 2048 2 2 . 5 120 2 . 0 0 . 3 20 1 2048 (cid:2) 2048 3 3 . 8 120 2 . 0 0 . 3 10 1 2048 (cid:2) 2048 4 1 . 70 300 2 . 7 0 . 1 51 51 4096 (cid:2) 4096 5 1 . 34 300 2 . 7 0 . 1 54 34 4096 (cid:2) 4096 6 1 . 07 300 2 . 7 0 . 1 80 34 4096 (cid:2) 4096 7 1 . 38 300 2 . 2 0 . 1 54 34 4096 (cid:2) 4096 8 1 . 35 300 2 . 0 0 . 1 20 20 3712 (cid:2) 3712 9 0 . 93 300 2 . 7 0 . 04 20 20 4096 (cid:2) 4096 apix : Pixel size in Ångstrom . kV : high tension of the micrographs . Cs : spherical aberration coefﬁcient . Ac : amplitude contrast used for CTF determination . Dose : Total dose of all frames , e / Å 2 . Table 2 Typical speed of Gctf for different types of application . a Dataset - 3 ( s ) Dataset - 9 ( s ) Dataset - 5 ( s ) Dataset - 6 ( local b ) ( s ) Dataset - 5 ( movie c ) ( s ) GTX750 Ti , HDD 0 . 29 0 . 59 1 . 14 4 . 46 4 . 27 Tesla K40 , NFS 0 . 65 0 . 76 1 . 00 3 . 58 7 . 88 K5000 , NFS 0 . 68 1 . 18 1 . 34 4 . 31 13 . 07 GTX980 , NFS 0 . 36 0 . 60 0 . 75 3 . 48 5 . 60 GTX980 , SSD 0 . 10 0 . 16 0 . 26 1 . 93 2 . 20 a Time of each micrograph in average . b 44 particles in total . c 20 frames , coherent averaging . K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 7 in three low contrast micrographs but with a bit larger difference ( (cid:4) 600 Å ) from Gctf or CTFFIND3 ( Fig . 5 in ( Zhang , 2015 ) ) . It should be noted that all these CTF determination results were generated using the defaults parameters rather than the potential best results from developers . Indeed , the developers can always get better results using their own programs . Also , these results just represent the difference of CTF determination among programs rather the true accuracy . Large Gaussian white noise ( 10 times standard deviation ) was added to the micrographs for CTF determination accuracy compar - ison . All the results except the three low contrast micrographs from both Gctf and CTFFIND3 are still essentially correct and com - parable ( Fig . 6 in ( Zhang , 2015 ) ) , in spite of enlarged errors ( Gctf 532 ± 96 Å , CTFFIND3 695 ± 125 Å ) compared to their averaged defocus of the original micrographs . In contrast , almost none of the CTF determination results were correct from these highly noisy 123 micrographs by FASTDEF or ACE2 . During the preparation of this paper , a benchmark study of CTF determination on challenging cases was published ( Marabini et al . , 2015 ) . Therefore all the datasets were downloaded for testing Gctf . The averaged differences between Gctf and CTFFIND3 ( upload 287 by Dr . Grigorieff ) are smaller than 400 Å for almost all datasets ( Fig . 6 ) . All differences of individual micrographs are also available ( Fig . 7 in ( Zhang , 2015 ) ) . All the raw CTF determination results from Gctf are attached for open comparison ( Supplementary Tables S1 and S2 and Supplementary Fig . S1 in ( Zhang , 2015 ) ) as well . The convincing proof of CTF determination accuracy of Gctf came out from several near - atomic resolution maps published recently ( Brown et al . , 2015 ; Urnavicius et al . , 2015 ; Zhu et al . , 2015 ) and more to be published soon . 3 . 4 . Micrograph evaluation A summary of CTF determination results by Gctf is presented in Table 2 of ( Zhang , 2015 ) using the described approach ( Sec - tion 2 . 10 ) . Several representative Gctf results were shown in Table 2 of ( Zhang , 2015 ) . In general , the results on direct electron detectors are much better than those on CCD . In the case of a high quality dynactin dataset on Falcon II detector , 99 . 7 % or 97 . 9 % micrographs are evaluated usable based on 8 Å or 4 Å criterion . The HAV dataset on K2 summit detector shows comparable results . The chaperonin dataset ( Zhang et al . , 2013 ) on UltraScan4000 CCD shows worse results , 92 . 7 % are evaluated as usable based on 8 Å criterion and only a quarter is evaluated as usable based on 4 Å criterion . Note that the CTF determination results which were detected to be ‘unusable’ could always be traced to a problem of the micrographs ( Fig . 8 in ( Zhang , 2015 ) ) . The veriﬁcation itself might also be affected by high noise at near - atomic resolution . Therefore , manually examination by EPA is highly recommended . A typical micrograph from HAV ( Dataset - 8 ) showed clear Thon rings at 4 Å resolution by EPA ( Fig . 7b ( iii ) ) . Comparable results could not be obtained from origi - nal power spectra ( Fig . 7b ( i ) ) or circular averaging ( Fig . 7b ( ii ) ) . 3 . 5 . Robustness Gctf was used to determine the CTFs of different datasets from three examples , dynactin ( in Dataset - 6 ) , HAV ( in Dataset - 9 ) and a pure carbon on Quantifoil grid ( in Dataset - 7 ) using variable ranges of four changeable parameters : resolution range , astigmatism , box size and B - factors . Gctf could correctly determine the defocus of an HAV dataset with high resolution cutoffs between Nyquist and 20 Å ( e . g . using resolution ranges 500 – 20 Å , 500 – 6 . 0 Å or 500 – 2 . 7 Å etc . ) or with a low resolution cutoffs between + 1 to (cid:4) 8 Å ( e . g . 500 – 3 . 0 Å , 15 – 3 . 0 Å , 8 . 0 – 3 . 0 Å etc . ) ( Fig . 8a ) . Movie S1 – 3 in ( Zhang , 2015 ) are presented to show a clear view of the robustness against a series of resolution cutoffs . Only when the high resolution cutoff was lower than 20 Å ( e . g . 500 – 50 Å , 500 – 40 Å , 500 – 30 Å etc . ) or the low resolution cutoff was higher than 8 Å ( e . g . 6 . 0 – 3 . 0 Å , 5 . 0 – 3 . 0 Å , 4 . 0 – 3 . 0 Å etc . ) , CTF determination became unstable and the results are not reliable . For dynactin , which was collected on thin carbon ﬁlm , the resolution cutoff range was more robust ( Fig . 9a in ( Zhang , 2015 ) ) . These results suggest the default resolu - tion range ( 50 – 4 Å ) for Gctf does not normally need optimization . This is quite helpful for automatic cryoEM data processing . Gctf can ﬁnd the correct astigmatism with input values between 10 Å and 10 , 000 Å for an actual astigmatism of (cid:4) 1800 Å ( Fig . 8b ) . This suggests that Gctf can automatically reﬁne the astigmatism of any practical cryoEM micrographs , which usually ranges from 200 Å to 2000 Å , using the default value ( 1000 Å ) . The relatively stable range of input Bfactor is around 0 – 1500 Å 2 for the HAV Dataset ( Fig . 9b and c in ( Zhang , 2015 ) ) , no need for optimizing the default value ( 150 Å 2 ) . In some extreme cases , e . g . very big defocus and astigmatism , CTF determination using a too low Bfactor might not be stable ( Fig . 9d in ( Zhang , 2015 ) ) , while using a too big Bfactor might introduce low - frequency bias because it severely down - weight high frequency . The optimization of Bfactor and resolution range using ‘REBS’ method helps to get better accuracy in such extreme case ( Fig . 10 in ( Zhang , 2015 ) ) . Gctf uses relatively larger box ( 1024 by default ) for better CTF determination because small box affect both accuracy and manual diagnosis ( Fig . 11 in ( Zhang , 2015 ) ) . The big error ( (cid:4) 1100 Å in one case ) due to very small box size ( 128 ) is not acceptable for near atomic reconstruction ( Fig . 1 ) . On the other hand , the box size should not be too big for local CTF reﬁnement . Otherwise , the improvement is not signiﬁcant . Gctf re - calculates the FFT using new box size 512 for local reﬁnement . 3 . 6 . Challenging cases of CTF determination For easy cases , e . g . micrographs with carbon ﬁlm at high dose , results from all available CTF determination programs are compa - rable . The exceptions are cases with large astigmatism since some programs , only determine averaged defocus . The differences among programs become signiﬁcant for challenging cases . Gctf 0 5 10 15 20 25 30 35 T i m e ( m i n ) Speed comparison CTFFIND3 ( 1X ) CTFFIND4 ( 10X ) FASTDEF ( 10X ) ACE2 ( 10X ) GCTF ( 1000X ) Fig . 5 . Speed comparison of several popular programs with Gctf . All parameters of each program were set as the default ( CTFFIND3 / 4 called by Relion ) . Due to the large speed differences among programs , they were tested using different number of micrographs for multiple times : CTFFIND3 on one micrograph , CTFFIND4 , FASTDEF , ACE2 on 10 micrographs , while Gctf on 1000 micrographs . Gctf was running on a single GTX 980 GPU and the other programs on Intel Xeon E5 - 2643 v2 CPU . 8 K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 can accurately determine the CTF for several challenging cases , e . g . low contrast micrographs collected on CCD ( Fig . 12a in ( Zhang , 2015 ) ) , micrographs with very small defocus ( e . g . < 0 . 5 l m , Fig . 12b in ( Zhang , 2015 ) ) , very large defocus ( e . g . > 7 l m , Fig . 12c in ( Zhang , 2015 ) ) or very large astigmatism ( e . g . > 0 . 5 l m , Fig . 10 in ( Zhang , 2015 ) ) and samples containing ring - like features ( e . g . DNA origami ) , single frames from a movie ( Fig . 9a ) and so on . Especially , the power of Gctf is demonstrated by its ability to determine the CTF of single frames from a movie with doses of only 1 – 2 e / Å 2 ( Fig . 9a ) ( Movie S4 in ( Zhang , 2015 ) ) . By averaging adjacent frames ( e . g . 5 – 10 ) , the results are accurate enough to detect the changes of Z - height ( Fig . 9b ) . 3 . 7 . Signiﬁcant improvement of defocus accuracy by local reﬁnement for each particle Gctf can estimate the defocus for each particle accurately using the current method described in Section 2 . 5 . One good example , from a high quality dynactin micrograph with a typical defocus variation is shown in Fig . 10 . The peaks of the circularly averaged Thon rings are clearly visible for each particle up to 4 Å . A compar - ison of two representative particles shows that their Thon rings are obviously shifted , almost reversed at higher than 5 Å resolution . A clear comparison between these two particles is shown from Movie S5 in ( Zhang , 2015 ) . - 600 - 400 - 200 0 200 400 600 800 1000 1200 1 2 3 4 5 6 7 8 9 10 D e f o c u s d i ff e r e n ces ( Å ) Average difference Middle difference Fig . 6 . Statistics of the defocus differences between Gctf and CTFFIND3 for the nine benchmark datasets . Number 10 is a dynactin dataset used in Fig . 5 of ( Zhang , 2015 ) . Blue columns represent the averaged differences ; red columns represent the middle differences , meaning 50 % micrographs have the differences lower or higher than this value in each dataset . Simulated Observed Circular Average Equiphase Average Circular Average EquiphaseAverage Observed 9Å 4Å ( a ) ( b ) 6Å 9Å 6Å 4Å ( i ) ( ii ) ( iii ) Fig . 7 . Equiphase average for better diagnosis . ( a ) Different spectra images of a typical cryoEM micrograph of HAV ( Dataset - 8 ) with (cid:4) 1800 Å astigmatism ; left top : background - subtracted LAS ; right top : circular average ; left bottom : equiphase average ; right bottom : simulated . ( b ) Enlarged region from 9 Å to 4 Å for detailed comparison of different diagnostic methods . Thong rings on the left sides in all the three images represent the simulated amplitude spectra ; the right sides represent the observed spectra visualized in different methods . Obviously , Thong rings from the original spectra ( i ) are almost invisible at higher than 9 Å even after background reduction . After circular average ( ii ) , the rings become clearer but signiﬁcantly off the correct peak because of the large astigmatism . Some rings are almost in reverse contrast , indicating the circular average is meaningless at such resolution . The equiphase average ( iii ) makes all the rings clearly visible up to 4 Å . K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 9 The local defocus variation can be much larger than expected from tilt micrographs . The maximum and standard deviation of the averaged local defocus for all micrographs in Dataset - 6 were plotted ( Fig . 13 in ( Zhang , 2015 ) ) . The standard deviations of local defocus for over 50 % micrographs are actually larger than the the - oretical value of a micrograph with 10 degree tilt . The maximum local defocus deviations for about one third micrographs are even larger than the theoretical value of a micrograph with 15 degree Fig . 8 . Robustness test of CTF determination using varying resolution cutoff or estimated astigmatism as input . ( a ) Typical CryoEM micrograph of HAV was selected and systemically examined to test the robustness of Gctf . The blue points represent results by high resolution cutoff and the red points by low resolution cutoff . ( b ) The input values of astigmatism ranging from 10 Å to 10 , 000 Å were used as initial estimation for CTF determination . All input values in this range generated almost identical results . Therefore , there is no need for optimizing the input astigmatism in this case . Blue and red lines represent defocus U and V respectively . Green line represents the azimuthal angle . Fig . 9 . CTFdetermination ofsingle framesof amovie . ( a ) Averagedmovie ( top ) and singleframe ( bottom ) of dynactin ( Dataset - 5 ) . Moviewas takenonFEI TitanKrios , FalconII detector at the dose of 1 . 6 e / ( Å 2 (cid:6) frame ) . ( b ) CTF determination using the averaged movie ( top ) or a single frame ( bottom ) . For both images , the left is simulated CTF and the right is observed LAS . Thedetermined defocus ð z u ; z v ; h ast Þ of the averagedmovie is ( 41 , 642 . 58 Å , 41 , 140 . 62 Å , 61 . 67 (cid:3) ) and the ﬁrst frame is ( 41 , 711 . 86 Å , 41 , 196 . 36 Å , 52 . 80 (cid:3) ) . The difference is ( 69 . 28 Å , 55 . 74 Å , 8 . 87 (cid:3) ) . ( c ) The changes of averaged defocus ð z u þ z v Þ = 2 with the accumulation of doses on the micrograph . Slightly different from ( b ) , the CTF determination for each frame was performed by averaging 9 adjacent frames ( e . g . 11 – 19 for frame 15 ) to enhance the SNR . 10 K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 tilt . On the other hand , the grid was proved to be ﬂat by the local defocus variation in several regions of completely burned carbon ( Fig . 14a in ( Zhang , 2015 ) ) . In these regions the local defocus variation is smaller than 30 Å which is theoretically equivalent to (cid:4) 3 degree tilt . Therefore , the local defocus variation in cryoEM micrographs is not attributed to tilt , but other factors such as uneven ice , carbon support or charging . In addition to self - consistency veriﬁcation of global CTF deter - mination , local defocus variation determined by Gctf can also be used to detect abnormal micrographs . Micrographs with very big 5Å Gctf result : 3 . 92µm Fitted by : 3 . 87µm 0 . 18 0 . 20 0 . 22 Gctf result : 3 . 87µm Fitted by : 3 . 87µm 5Å Gctf result : 3 . 92µm Fitted by : 3 . 92µm 5Å Observed Simulated 1 ( b ) ( c ) ( d ) 2 ( a ) 0 . 18 0 . 20 0 . 22 0 . 18 0 . 20 0 . 22 Fig . 10 . An example showing the importance of local CTF reﬁnement . ( a ) The raw micrograph of dynactin ( Dataset - 6 ) . ( b ) The local defocus for this particle determined by Gctf is 3 . 92 l m . The red arrow indicates the ﬁtting is almost perfect up to 5 Å . The black curve represents the circularly averaged LAS of particle 1 ; the blue curve represents the comparison with Gctf determination . ( c ) Similar to ( b ) but for particle 2 . The defocus of this particle is 3 . 87 l m . The ﬁtting of CTF is also perfect up to 5 Å . ( d ) Comparison between the circularly averaged LAS of particle 1 and simulated amplitude spectra using defocus of particle 2 . In contrast to ( b ) or ( c ) , the simulated CTF curve does not ﬁt the observed curve at high resolution , indicating the importance the local reﬁnement for near atomic resolution reconstruction . 0 0 . 2 0 . 4 0 . 6 0 . 8 1 0 0 . 1 0 . 2 0 . 3 0 . 4 Global CTF Local CTF 0 0 . 2 0 . 4 0 . 6 0 . 8 1 0 0 . 1 0 . 2 0 . 3 0 . 4 Local CTF Global CTF Dynactin HAV 4 . 7Å 4 . 4Å 3 . 5Å 3 . 4Å ( a ) ( b ) Fig . 11 . FSC comparison between global and local CTF . ( a ) Comparison of Dynactin FSC curves with ( green ) and without ( red ) doing local defocus reﬁnement . 86 , 916 particles were used for ﬁnal reconstruction from Dataset - 7 . ( b ) Comparison of FSC curves of HAV with ( green ) and without ( red ) doing local defocus reﬁnement . 2025 particles were used for ﬁnal reconstruction in Dataset - 8 . K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12 11 local defocus deviation ( e . g . maximum deviation > 1000 Å ) were always low - quality ( Fig . 14b in ( Zhang , 2015 ) ) or partially unus - able ( Fig . 14c and d in ( Zhang , 2015 ) ) . The speed and accuracy of local defocus reﬁnement in Gctf was helpful during the determination of the near - atomic resolution cryoEM structure of dynactin ( Urnavicius et al . , 2015 ) ( Fig . 15a in ( Zhang , 2015 ) ) and HAV ( Fig . 15b in ( Zhao and Chu , 2014 ) , by cour - tesy of Wang ) . Generally , the improvement depends on the magni - tude of the defocus variation in the micrographs . Local defocus reﬁnement by Gctf never made the ﬁnal reconstructions worse in the current test . In one of the best cases for dynactin in a thin car - bon layer support , the resolution was improved from 4 . 7 Å to 4 . 4 Å ( Fig . 11a ) . In the case of HAV , which was vitriﬁed without carbon substrate and therefore assumed to be less affected by uneven sup - port , local reﬁnement could also improve the resolution from 3 . 5 Å to 3 . 4 Å ( Fig . 11b ) . 4 . Conclusion Gctf is a convenient , accurate , robust and very fast CTF determi - nation and correction program . GPU acceleration , the fast ‘1S2R’ procedure and optimized programing strategy all together have made it a real - time program . Approaches of self - consistency veri - ﬁcation and micrograph quality evaluation have also been pro - posed for automatic CTF determination and micrograph selection . Approaches for local CTF reﬁnement of each particle in a micro - graph or frames in a movie have been proposed to improve the accuracy of CTF determination . Extensive practical tests proved its power to facilitate cryoEM image processing and could improve the ﬁnal resolution of 3D cryoEM reconstructions in some cases . Acknowledgements This work was funded by the Medical Research Council , United Kingdom ( MC _ UP _ A025 _ 1011 ) and a Wellcome Trust New Investi - gator Award ( WT100387 ) to Dr . Andrew Carter , in whose lab the Gctf program was developed . I thank Dr . Andrew Carter for help with writing the manuscript and Dr . Aristides Diamant for proof reading . I thank Dr . Chris Russo , Dr . Sjors Scheres and Dr . Richard Henderson for their discussion on CTF determination and valuable suggestions on the both the program and this paper . I also thank Dr . Shaoxia Chen , Dr . Christos Savva and Dr . Greg McMullan for their support for electron microscopy ; Dr . Jake Grimmett and Dr . Toby Darling for support with scientiﬁc computing ; Linas Urnavi - cius for supplying the dynactin complex ; Dr . Xiangxi Wang and Ling Zhu for offering their cryoEM micrographs of HAV as a case study ; Dr . Fei Sun for offering the cryoEM micrographs of Chaper - onin ; Dr . Roberto Marabini for his help with using the CTF bench - marking website . I also thank all initial users of Gctf , especially Dr . Alan Brown , Dr . Xiangxi Wang , Ling Zhu , Dr . Jun Dong , Shengliu Wang et al . , for their valuable feedbacks to further improve Gctf , help on setting up and running Gctf at the MRC - LMB ( Cambridge ) , STRUBI ( Oxford ) , Institute of Biophysics ( Beijing ) or by personal communication before Gctf is ofﬁcially released . References Amunts , A . , Brown , A . , Toots , J . , Scheres , S . H . , Ramakrishnan , V . , 2015 . Ribosome . The structure of the human mitochondrial ribosome . Science 348 , 95 – 98 . Bai , X . C . , McMullan , G . , Scheres , S . H . , 2015 . How cryo - EM is revolutionizing structural biology . Trends Biochem . Sci . 40 , 49 – 57 . Bai , X . C . , Fernandez , I . S . , McMullan , G . , Scheres , S . H . , 2013 . Ribosome structures to near - atomic resolution from thirty thousand cryo - EM particles . Elife 2 , e00461 . Bartesaghi , A . , Merk , A . , Banerjee , S . , Matthies , D . , Wu , X . , Milne , J . L . , Subramaniam , S . , 2015 . 2 . 2 Å resolution cryo - EM structure of beta - galactosidase in complex with a cell - permeant inhibitor . Science . Brown , A . , Shao , S . , Murray , J . , Hegde , R . S . , Ramakrishnan , V . , 2015 . Structural basis for stop codon recognition in eukaryotes . Nature . DeRosier , D . J . , 2000 . Correction of high - resolution data for curvature of the Ewald sphere . Ultramicroscopy 81 , 83 – 98 . Glaeser , R . M . , Typke , D . , Tiemeijer , P . C . , Pulokas , J . , Cheng , A . , 2011 . Precise beam - tilt alignment and collimation are required to minimize the phase error associated with coma in high - resolution cryo - EM . J . Struct . Biol . 174 , 1 – 10 . Grigorieff , N . , 2007 . FREALIGN : high - resolution reﬁnement of single particle structures . J . Struct . Biol . 157 , 117 – 125 . Heymann , J . B . , Chagoyen , M . , Belnap , D . M . , 2005 . Common conventions for interchange and archiving of three - dimensional electron microscopy information in structural biology . J . Struct . Biol . 151 , 196 – 207 . Jiang , J . , Pentelute , B . L . , Collier , R . J . , Zhou , Z . H . , 2015 . Atomic structure of anthrax protective antigen pore elucidates toxin translocation . Nature . Li , X . , Grigorieff , N . , Cheng , Y . , 2010 . GPU - enabled FREALIGN : accelerating single particle 3D reconstruction and reﬁnement in Fourier space on graphics processors . J . Struct . Biol . 172 , 407 – 412 . Li , X . , Mooney , P . , Zheng , S . , Booth , C . R . , Braunfeld , M . B . , Gubbens , S . , Agard , D . A . , Cheng , Y . , 2013 . Electron counting and beam - induced motion correction enable near - atomic - resolution single - particle cryo - EM . Nat . Methods 10 , 584 – 590 . Ludtke , S . J . , Baldwin , P . R . , Chiu , W . , 1999 . EMAN : semiautomated software for high - resolution single - particle reconstructions . J . Struct . Biol . 128 , 82 – 97 . Mallick , S . P . , Carragher , B . , Potter , C . S . , Kriegman , D . J . , 2005 . ACE : automated CTF estimation . Ultramicroscopy 104 , 8 – 29 . Marabini , R . , Carragher , B . , Chen , S . , Chen , J . , Cheng , A . , Downing , K . H . , Frank , J . , Grassucci , R . A . , Bernard Heymann , J . , Jiang , W . , Jonic , S . , Liao , H . Y . , Ludtke , S . J . , Patwari , S . , Piotrowski , A . L . , Quintana , A . , Sorzano , C . O . , Stahlberg , H . , Vargas , J . , Voss , N . R . , Chiu , W . , Carazo , J . M . , 2015 . CTF challenge : result summary . J . Struct . Biol . Mindell , J . A . , Grigorieff , N . , 2003 . Accurate determination of local defocus and specimen tilt in electron microscopy . J . Struct . Biol . 142 , 334 – 347 . Nogales , E . , Scheres , S . H . , 2015 . Cryo - EM : a unique tool for the visualization of macromolecular complexity . Mol . Cell 58 , 677 – 689 . Paulsen , C . E . , Armache , J . P . , Gao , Y . , Cheng , Y . , Julius , D . , 2015 . Structure of the TRPA1 ion channel suggests regulatory mechanisms . Nature 520 , 511 – 517 . Penczek , P . A . , Fang , J . , Li , X . , Cheng , Y . , Loerke , J . , Spahn , C . M . , 2014 . CTER - rapid estimation of CTF parameters with error assessment . Ultramicroscopy 140 , 9 – 19 . Rohou , A . , Grigorieff , N . , 2015 . CTFFIND4 : fast and accurate defocus estimation from electron micrographs . J . Struct . Biol . Russo , C . J . , Passmore , L . A . , 2014 . Electronmicroscopy : ultrastable goldsubstrates for electron cryomicroscopy . Science 346 , 1377 – 1380 . Scheres , S . H . , 2012 . RELION : implementation of a Bayesian approach to cryo - EM structure determination . J . Struct . Biol . 180 , 519 – 530 . Shaikh , T . R . , Gao , H . , Baxter , W . T . , Asturias , F . J . , Boisset , N . , Leith , A . , Frank , J . , 2008 . SPIDER image processing for single - particle reconstruction of biological macromolecules from electron micrographs . Nat . Protoc . 3 , 1941 – 1974 . Shatsky , M . , Arbelaez , P . , Han , B . G . , Typke , D . , Brenner , S . E . , Malik , J . , Glaeser , R . M . , 2014 . Automated particle correspondence and accurate tilt - axis detection in tilted - image pairs . J . Struct . Biol . 187 , 66 – 75 . Sorzano , C . O . , Marabini , R . , Velazquez - Muriel , J . , Bilbao - Castro , J . R . , Scheres , S . H . , Carazo , J . M . , Pascual - Montano , A . , 2004 . XMIPP : a new generation of an open - source image processing package for electron microscopy . J . Struct . Biol . 148 , 194 – 204 . Tang , G . , Peng , L . , Baldwin , P . R . , Mann , D . S . , Jiang , W . , Rees , I . , Ludtke , S . J . , 2007 . EMAN2 : an extensible image processing suite for electron microscopy . J . Struct . Biol . 157 , 38 – 46 . Taylor , D . W . , Zhu , Y . , Staals , R . H . , Kornfeld , J . E . , Shinkai , A . , van der Oost , J . , Nogales , E . , Doudna , J . A . , 2015 . Structural biology . Structures of the CRISPR - Cmr complex reveal mode of RNA target positioning . Science 348 , 581 – 585 . Urnavicius , L . , Zhang , K . , Diamant , A . G . , Motz , C . , Schlager , M . A . , Yu , M . , Patel , N . A . , Robinson , C . V . , Carter , A . P . , 2015 . The structure of the dynactin complex and its interaction with dynein . Science 347 , 1441 – 1446 . Vargas , J . , Oton , J . , Marabini , R . , Jonic , S . , de la Rosa - Trevin , J . M . , Carazo , J . M . , Sorzano , C . O . , 2013 . FASTDEF : fast defocus and astigmatism estimation for high - throughput transmission electron microscopy . J . Struct . Biol . 181 , 136 – 148 . Voortman , L . M . , Stallinga , S . , Schoenmakers , R . H . , van Vliet , L . J . , Rieger , B . , 2011 . A fast algorithm for computing and correcting the CTF for tilted , thick specimens in TEM . Ultramicroscopy 111 , 1029 – 1036 . Wade , R . H . , 1992 . A brief look at imaging and contrast transfer . Ultramicroscopy 46 , 145 – 156 . Wang , X . , Ren , J . , Gao , Q . , Hu , Z . , Sun , Y . , Li , X . , Rowlands , D . J . , Yin , W . , Wang , J . , Stuart , D . I . , Rao , Z . , Fry , E . E . , 2015 . Hepatitis A virus and the origins of picornaviruses . Nature 517 , 85 – 88 . Xu , W . , Xu , F . , Jones , M . , Keszthelyi , B . , Sedat , J . , Agard , D . , Mueller , K . , 2010 . High - performance iterative electron tomography reconstruction with long - object compensation using graphics processing units ( GPUs ) . J . Struct . Biol . 171 , 142 – 153 . Zhang , K . , 2015 . Methods , data and results to support Gctf . Data in Brief ( submitted ) . Zhang , K . , Wang , L . , Liu , Y . , Chan , K . Y . , Pang , X . , Schulten , K . , Dong , Z . , Sun , F . , 2013 . Flexible interwoven termini determine the thermal stability of thermosomes . Protein Cell 4 , 432 – 444 . Zhao , K . , Chu , X . , 2014 . G - BLASTN : accelerating nucleotide alignment by graphics processors . Bioinformatics 30 , 1384 – 1391 . Zhao , M . , Wu , S . , Zhou , Q . , Vivona , S . , Cipriano , D . J . , Cheng , Y . , Brunger , A . T . , 2015 . Mechanistic insights into the recycling machine of the SNARE complex . Nature 518 , 61 – 67 . Zhu , L . , Wang , X . , Ren , J . , Porta , C . , Wenham , H . , Ekstrom , J . O . , Panjwani , A . , Knowles , N . J . , Kotecha , A . , Siebert , C . A . , Lindberg , A . M . , Fry , E . E . , Rao , Z . , Tuthill , T . J . , Stuart , D . I . , 2015 . Structure of Ljungan virus provides insight into genome packaging of this picornavirus . Nat . Commun . 6 , 8316 . 12 K . Zhang / Journal of Structural Biology 193 ( 2016 ) 1 – 12